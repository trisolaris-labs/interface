{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WalletLinkProvider = void 0;\n\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n\nconst util_1 = require(\"../util\");\n\nconst eth_eip712_util_1 = __importDefault(require(\"../vendor-js/eth-eip712-util\"));\n\nconst FilterPolyfill_1 = require(\"./FilterPolyfill\");\n\nconst JSONRPC_1 = require(\"./JSONRPC\");\n\nconst eth_rpc_errors_1 = require(\"eth-rpc-errors\");\n\nconst safe_event_emitter_1 = __importDefault(require(\"@metamask/safe-event-emitter\"));\n\nconst SubscriptionManager_1 = require(\"./SubscriptionManager\");\n\nconst LOCAL_STORAGE_ADDRESSES_KEY = \"Addresses\";\n\nclass WalletLinkProvider extends safe_event_emitter_1.default {\n  constructor(options) {\n    super();\n    this._filterPolyfill = new FilterPolyfill_1.FilterPolyfill(this);\n    this._subscriptionManager = new SubscriptionManager_1.SubscriptionManager(this);\n    this._relay = null;\n    this._addresses = [];\n    this.hasMadeFirstChainChangedEmission = false; // true if mobile client has sent message to override jsonRpcUrl+chainId\n\n    this.isChainOverridden = false;\n    this._send = this.send;\n    this._sendAsync = this.sendAsync;\n    this.setProviderInfo = this.setProviderInfo.bind(this);\n    this.updateProviderInfo = this.updateProviderInfo.bind(this);\n    this.setAppInfo = this.setAppInfo.bind(this);\n    this.enable = this.enable.bind(this);\n    this.close = this.close.bind(this);\n    this.send = this.send.bind(this);\n    this.sendAsync = this.sendAsync.bind(this);\n    this.request = this.request.bind(this);\n    this._setAddresses = this._setAddresses.bind(this);\n    this.scanQRCode = this.scanQRCode.bind(this);\n    this.arbitraryRequest = this.arbitraryRequest.bind(this);\n    this.childRequestEthereumAccounts = this.childRequestEthereumAccounts.bind(this);\n    this._chainId = util_1.ensureIntNumber(options.chainId || 1);\n    this._jsonRpcUrl = options.jsonRpcUrl;\n    this._overrideIsMetaMask = options.overrideIsMetaMask;\n    this._relayProvider = options.relayProvider;\n    this._storage = options.storage;\n    this._relayEventManager = options.relayEventManager;\n    const chainIdStr = util_1.prepend0x(this._chainId.toString(16)); // indicate that we've connected, for EIP-1193 compliance\n\n    this.emit(\"connect\", {\n      chainIdStr\n    });\n\n    const cachedAddresses = this._storage.getItem(LOCAL_STORAGE_ADDRESSES_KEY);\n\n    if (cachedAddresses) {\n      const addresses = cachedAddresses.split(\" \");\n\n      if (addresses[0] !== \"\") {\n        this._addresses = addresses;\n        this.emit(\"accountsChanged\", addresses);\n      }\n    }\n\n    this._subscriptionManager.events.on(\"notification\", notification => {\n      this.emit(\"message\", {\n        type: notification.method,\n        data: notification.params\n      });\n    });\n\n    if (this._addresses.length > 0) {\n      this.initializeRelay();\n    }\n  }\n\n  get selectedAddress() {\n    return this._addresses[0] || undefined;\n  }\n\n  get networkVersion() {\n    return this._chainId.toString(10);\n  }\n\n  get chainId() {\n    return util_1.prepend0x(this._chainId.toString(16));\n  }\n\n  get isWalletLink() {\n    return true;\n  }\n  /**\n   * Some DApps (i.e. Alpha Homora) seem to require the window.ethereum object return\n   * true for this method.\n   */\n\n\n  get isMetaMask() {\n    return this._overrideIsMetaMask;\n  }\n\n  get host() {\n    return this._jsonRpcUrl;\n  }\n\n  get connected() {\n    return true;\n  }\n\n  isConnected() {\n    return true;\n  }\n\n  setProviderInfo(jsonRpcUrl, chainId) {\n    if (this.isChainOverridden) return;\n    this.updateProviderInfo(jsonRpcUrl, chainId, false);\n  }\n\n  updateProviderInfo(jsonRpcUrl, chainId, fromRelay) {\n    if (fromRelay) this.isChainOverridden = true;\n    const originalChainId = this._chainId;\n    this._chainId = util_1.ensureIntNumber(chainId);\n    const chainChanged = this._chainId !== originalChainId;\n    this._jsonRpcUrl = jsonRpcUrl;\n\n    if (chainChanged || !this.hasMadeFirstChainChangedEmission) {\n      this.emit(\"chainChanged\", this._chainId);\n      this.hasMadeFirstChainChangedEmission = true;\n    }\n  }\n\n  setAppInfo(appName, appLogoUrl) {\n    this.initializeRelay().then(relay => relay.setAppInfo(appName, appLogoUrl));\n  }\n\n  async enable() {\n    if (this._addresses.length > 0) {\n      return this._addresses;\n    }\n\n    return await this._send(JSONRPC_1.JSONRPCMethod.eth_requestAccounts);\n  }\n\n  close() {\n    this.initializeRelay().then(relay => relay.resetAndReload());\n  }\n\n  send(requestOrMethod, callbackOrParams) {\n    // send<T>(method, params): Promise<T>\n    if (typeof requestOrMethod === \"string\") {\n      const method = requestOrMethod;\n      const params = Array.isArray(callbackOrParams) ? callbackOrParams : callbackOrParams !== undefined ? [callbackOrParams] : [];\n      const request = {\n        jsonrpc: \"2.0\",\n        id: 0,\n        method,\n        params\n      };\n      return this._sendRequestAsync(request).then(res => res.result);\n    } // send(JSONRPCRequest | JSONRPCRequest[], callback): void\n\n\n    if (typeof callbackOrParams === \"function\") {\n      const request = requestOrMethod;\n      const callback = callbackOrParams;\n      return this._sendAsync(request, callback);\n    } // send(JSONRPCRequest[]): JSONRPCResponse[]\n\n\n    if (Array.isArray(requestOrMethod)) {\n      const requests = requestOrMethod;\n      return requests.map(r => this._sendRequest(r));\n    } // send(JSONRPCRequest): JSONRPCResponse\n\n\n    const req = requestOrMethod;\n    return this._sendRequest(req);\n  }\n\n  sendAsync(request, callback) {\n    if (typeof callback !== \"function\") {\n      throw new Error(\"callback is required\");\n    } // send(JSONRPCRequest[], callback): void\n\n\n    if (Array.isArray(request)) {\n      const arrayCb = callback;\n\n      this._sendMultipleRequestsAsync(request).then(responses => arrayCb(null, responses)).catch(err => arrayCb(err, null));\n\n      return;\n    } // send(JSONRPCRequest, callback): void\n\n\n    const cb = callback;\n\n    this._sendRequestAsync(request).then(response => cb(null, response)).catch(err => cb(err, null));\n  }\n\n  async request(args) {\n    if (!args || typeof args !== \"object\" || Array.isArray(args)) {\n      throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n        message: \"Expected a single, non-array, object argument.\",\n        data: args\n      });\n    }\n\n    const {\n      method,\n      params\n    } = args;\n\n    if (typeof method !== \"string\" || method.length === 0) {\n      throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n        message: \"'args.method' must be a non-empty string.\",\n        data: args\n      });\n    }\n\n    if (params !== undefined && !Array.isArray(params) && (typeof params !== \"object\" || params === null)) {\n      throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n        message: \"'args.params' must be an object or array if provided.\",\n        data: args\n      });\n    }\n\n    const newParams = params === undefined ? [] : params; // WalletLink Requests\n\n    const id = this._relayEventManager.makeRequestId();\n\n    const result = await this._sendRequestAsync({\n      method,\n      params: newParams,\n      jsonrpc: \"2.0\",\n      id\n    });\n    return result.result;\n  }\n\n  async scanQRCode(match) {\n    const relay = await this.initializeRelay();\n    const res = await relay.scanQRCode(util_1.ensureRegExpString(match));\n\n    if (typeof res.result !== \"string\") {\n      throw new Error(\"result was not a string\");\n    }\n\n    return res.result;\n  }\n\n  async arbitraryRequest(data) {\n    const relay = await this.initializeRelay();\n    const res = await relay.arbitraryRequest(data);\n\n    if (typeof res.result !== \"string\") {\n      throw new Error(\"result was not a string\");\n    }\n\n    return res.result;\n  }\n\n  async childRequestEthereumAccounts(childSessionId, childSessionSecret, dappName, dappLogoURL, dappURL) {\n    const relay = await this.initializeRelay();\n    await relay.childRequestEthereumAccounts(childSessionId, childSessionSecret, dappName, dappLogoURL, dappURL);\n    return true;\n  }\n\n  supportsSubscriptions() {\n    return false;\n  }\n\n  subscribe() {\n    throw new Error(\"Subscriptions are not supported\");\n  }\n\n  unsubscribe() {\n    throw new Error(\"Subscriptions are not supported\");\n  }\n\n  disconnect() {\n    return true;\n  }\n\n  _sendRequest(request) {\n    const response = {\n      jsonrpc: \"2.0\",\n      id: request.id\n    };\n    const {\n      method\n    } = request;\n    response.result = this._handleSynchronousMethods(request);\n\n    if (response.result === undefined) {\n      throw new Error(`WalletLink does not support calling ${method} synchronously without ` + `a callback. Please provide a callback parameter to call ${method} ` + `asynchronously.`);\n    }\n\n    return response;\n  }\n\n  _setAddresses(addresses) {\n    if (!Array.isArray(addresses)) {\n      throw new Error(\"addresses is not an array\");\n    }\n\n    this._addresses = addresses.map(address => util_1.ensureAddressString(address));\n    this.emit(\"accountsChanged\", this._addresses);\n\n    this._storage.setItem(LOCAL_STORAGE_ADDRESSES_KEY, addresses.join(\" \"));\n\n    window.dispatchEvent(new CustomEvent(\"walletlink:addresses\", {\n      detail: this._addresses\n    }));\n  }\n\n  _sendRequestAsync(request) {\n    return new Promise((resolve, reject) => {\n      try {\n        const syncResult = this._handleSynchronousMethods(request);\n\n        if (syncResult !== undefined) {\n          return resolve({\n            jsonrpc: \"2.0\",\n            id: request.id,\n            result: syncResult\n          });\n        }\n\n        const filterPromise = this._handleAsynchronousFilterMethods(request);\n\n        if (filterPromise !== undefined) {\n          filterPromise.then(res => resolve(Object.assign(Object.assign({}, res), {\n            id: request.id\n          }))).catch(err => reject(err));\n          return;\n        }\n\n        const subscriptionPromise = this._handleSubscriptionMethods(request);\n\n        if (subscriptionPromise !== undefined) {\n          subscriptionPromise.then(res => resolve({\n            jsonrpc: \"2.0\",\n            id: request.id,\n            result: res.result\n          })).catch(err => reject(err));\n          return;\n        }\n      } catch (err) {\n        return reject(err);\n      }\n\n      this._handleAsynchronousMethods(request).then(res => resolve(Object.assign(Object.assign({}, res), {\n        id: request.id\n      }))).catch(err => reject(err));\n    });\n  }\n\n  _sendMultipleRequestsAsync(requests) {\n    return Promise.all(requests.map(r => this._sendRequestAsync(r)));\n  }\n\n  _handleSynchronousMethods(request) {\n    const {\n      method\n    } = request;\n    const params = request.params || [];\n\n    switch (method) {\n      case JSONRPC_1.JSONRPCMethod.eth_accounts:\n        return this._eth_accounts();\n\n      case JSONRPC_1.JSONRPCMethod.eth_coinbase:\n        return this._eth_coinbase();\n\n      case JSONRPC_1.JSONRPCMethod.eth_uninstallFilter:\n        return this._eth_uninstallFilter(params);\n\n      case JSONRPC_1.JSONRPCMethod.net_version:\n        return this._net_version();\n\n      case JSONRPC_1.JSONRPCMethod.eth_chainId:\n        return this._eth_chainId();\n\n      default:\n        return undefined;\n    }\n  }\n\n  _handleAsynchronousMethods(request) {\n    const {\n      method\n    } = request;\n    const params = request.params || [];\n\n    switch (method) {\n      case JSONRPC_1.JSONRPCMethod.eth_requestAccounts:\n        return this._eth_requestAccounts();\n\n      case JSONRPC_1.JSONRPCMethod.eth_sign:\n        return this._eth_sign(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_ecRecover:\n        return this._eth_ecRecover(params);\n\n      case JSONRPC_1.JSONRPCMethod.personal_sign:\n        return this._personal_sign(params);\n\n      case JSONRPC_1.JSONRPCMethod.personal_ecRecover:\n        return this._personal_ecRecover(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_signTransaction:\n        return this._eth_signTransaction(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_sendRawTransaction:\n        return this._eth_sendRawTransaction(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_sendTransaction:\n        return this._eth_sendTransaction(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v1:\n        return this._eth_signTypedData_v1(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v2:\n        return this._throwUnsupportedMethodError();\n\n      case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v3:\n        return this._eth_signTypedData_v3(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v4:\n      case JSONRPC_1.JSONRPCMethod.eth_signTypedData:\n        return this._eth_signTypedData_v4(params);\n\n      case JSONRPC_1.JSONRPCMethod.walletlink_arbitrary:\n        return this._walletlink_arbitrary(params);\n    }\n\n    if (!this._jsonRpcUrl) throw Error(\"Error: No jsonRpcUrl provided\");\n    return window.fetch(this._jsonRpcUrl, {\n      method: \"POST\",\n      body: JSON.stringify(request),\n      mode: \"cors\",\n      headers: {\n        \"Content-Type\": \"application/json\"\n      }\n    }).then(res => res.json()).then(json => {\n      if (!json) {\n        throw eth_rpc_errors_1.ethErrors.rpc.parse({});\n      }\n\n      const response = json;\n      const {\n        error\n      } = response;\n\n      if (error) {\n        throw eth_rpc_errors_1.serializeError(error);\n      }\n\n      return response;\n    });\n  }\n\n  _handleAsynchronousFilterMethods(request) {\n    const {\n      method\n    } = request;\n    const params = request.params || [];\n\n    switch (method) {\n      case JSONRPC_1.JSONRPCMethod.eth_newFilter:\n        return this._eth_newFilter(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_newBlockFilter:\n        return this._eth_newBlockFilter();\n\n      case JSONRPC_1.JSONRPCMethod.eth_newPendingTransactionFilter:\n        return this._eth_newPendingTransactionFilter();\n\n      case JSONRPC_1.JSONRPCMethod.eth_getFilterChanges:\n        return this._eth_getFilterChanges(params);\n\n      case JSONRPC_1.JSONRPCMethod.eth_getFilterLogs:\n        return this._eth_getFilterLogs(params);\n    }\n\n    return undefined;\n  }\n\n  _handleSubscriptionMethods(request) {\n    switch (request.method) {\n      case JSONRPC_1.JSONRPCMethod.eth_subscribe:\n      case JSONRPC_1.JSONRPCMethod.eth_unsubscribe:\n        return this._subscriptionManager.handleRequest(request);\n    }\n\n    return undefined;\n  }\n\n  _isKnownAddress(addressString) {\n    try {\n      const address = util_1.ensureAddressString(addressString);\n      return this._addresses.includes(address);\n    } catch (_a) {}\n\n    return false;\n  }\n\n  _ensureKnownAddress(addressString) {\n    if (!this._isKnownAddress(addressString)) {\n      throw new Error(\"Unknown Ethereum address\");\n    }\n  }\n\n  _prepareTransactionParams(tx) {\n    const fromAddress = tx.from ? util_1.ensureAddressString(tx.from) : this.selectedAddress;\n\n    if (!fromAddress) {\n      throw new Error(\"Ethereum address is unavailable\");\n    }\n\n    this._ensureKnownAddress(fromAddress);\n\n    const toAddress = tx.to ? util_1.ensureAddressString(tx.to) : null;\n    const weiValue = tx.value != null ? util_1.ensureBN(tx.value) : new bn_js_1.default(0);\n    const data = tx.data ? util_1.ensureBuffer(tx.data) : Buffer.alloc(0);\n    const nonce = tx.nonce != null ? util_1.ensureIntNumber(tx.nonce) : null;\n    const gasPriceInWei = tx.gasPrice != null ? util_1.ensureBN(tx.gasPrice) : null;\n    const gasLimit = tx.gas != null ? util_1.ensureBN(tx.gas) : null;\n    const chainId = this._chainId;\n    return {\n      fromAddress,\n      toAddress,\n      weiValue,\n      data,\n      nonce,\n      gasPriceInWei,\n      gasLimit,\n      chainId\n    };\n  }\n\n  _requireAuthorization() {\n    if (this._addresses.length === 0) {\n      throw eth_rpc_errors_1.ethErrors.provider.unauthorized({});\n    }\n  }\n\n  _throwUnsupportedMethodError() {\n    throw eth_rpc_errors_1.ethErrors.provider.unsupportedMethod({});\n  }\n\n  async _signEthereumMessage(message, address, addPrefix, typedDataJson) {\n    this._ensureKnownAddress(address);\n\n    try {\n      const relay = await this.initializeRelay();\n      const res = await relay.signEthereumMessage(message, address, addPrefix, typedDataJson);\n      return {\n        jsonrpc: \"2.0\",\n        id: 0,\n        result: res.result\n      };\n    } catch (err) {\n      if (typeof err.message === \"string\" && err.message.match(/(denied|rejected)/i)) {\n        throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied message signature\");\n      }\n\n      throw err;\n    }\n  }\n\n  async _ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n    const relay = await this.initializeRelay();\n    const res = await relay.ethereumAddressFromSignedMessage(message, signature, addPrefix);\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: res.result\n    };\n  }\n\n  _eth_accounts() {\n    return this._addresses;\n  }\n\n  _eth_coinbase() {\n    return this.selectedAddress || null;\n  }\n\n  _net_version() {\n    return this._chainId.toString(10);\n  }\n\n  _eth_chainId() {\n    return util_1.hexStringFromIntNumber(this._chainId);\n  }\n\n  async _eth_requestAccounts() {\n    if (this._addresses.length > 0) {\n      return Promise.resolve({\n        jsonrpc: \"2.0\",\n        id: 0,\n        result: this._addresses\n      });\n    }\n\n    let res;\n\n    try {\n      const relay = await this.initializeRelay();\n      res = await relay.requestEthereumAccounts();\n    } catch (err) {\n      if (typeof err.message === \"string\" && err.message.match(/(denied|rejected)/i)) {\n        throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied account authorization\");\n      }\n\n      throw err;\n    }\n\n    if (!res.result) {\n      throw new Error(\"accounts received is empty\");\n    }\n\n    this._setAddresses(res.result);\n\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: this._addresses\n    };\n  }\n\n  _eth_sign(params) {\n    this._requireAuthorization();\n\n    const address = util_1.ensureAddressString(params[0]);\n    const message = util_1.ensureBuffer(params[1]);\n    return this._signEthereumMessage(message, address, false);\n  }\n\n  _eth_ecRecover(params) {\n    const message = util_1.ensureBuffer(params[0]);\n    const signature = util_1.ensureBuffer(params[1]);\n    return this._ethereumAddressFromSignedMessage(message, signature, false);\n  }\n\n  _personal_sign(params) {\n    this._requireAuthorization();\n\n    const message = util_1.ensureBuffer(params[0]);\n    const address = util_1.ensureAddressString(params[1]);\n    return this._signEthereumMessage(message, address, true);\n  }\n\n  _personal_ecRecover(params) {\n    const message = util_1.ensureBuffer(params[0]);\n    const signature = util_1.ensureBuffer(params[1]);\n    return this._ethereumAddressFromSignedMessage(message, signature, true);\n  }\n\n  async _eth_signTransaction(params) {\n    this._requireAuthorization();\n\n    const tx = this._prepareTransactionParams(params[0] || {});\n\n    try {\n      const relay = await this.initializeRelay();\n      const res = await relay.signEthereumTransaction(tx);\n      return {\n        jsonrpc: \"2.0\",\n        id: 0,\n        result: res.result\n      };\n    } catch (err) {\n      if (typeof err.message === \"string\" && err.message.match(/(denied|rejected)/i)) {\n        throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied transaction signature\");\n      }\n\n      throw err;\n    }\n  }\n\n  async _eth_sendRawTransaction(params) {\n    const signedTransaction = util_1.ensureBuffer(params[0]);\n    const relay = await this.initializeRelay();\n    const res = await relay.submitEthereumTransaction(signedTransaction, this._chainId);\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: res.result\n    };\n  }\n\n  async _eth_sendTransaction(params) {\n    this._requireAuthorization();\n\n    const tx = this._prepareTransactionParams(params[0] || {});\n\n    try {\n      const relay = await this.initializeRelay();\n      const res = await relay.signAndSubmitEthereumTransaction(tx);\n      return {\n        jsonrpc: \"2.0\",\n        id: 0,\n        result: res.result\n      };\n    } catch (err) {\n      if (typeof err.message === \"string\" && err.message.match(/(denied|rejected)/i)) {\n        throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied transaction signature\");\n      }\n\n      throw err;\n    }\n  }\n\n  async _eth_signTypedData_v1(params) {\n    this._requireAuthorization();\n\n    const typedData = util_1.ensureParsedJSONObject(params[0]);\n    const address = util_1.ensureAddressString(params[1]);\n\n    this._ensureKnownAddress(address);\n\n    const message = eth_eip712_util_1.default.hashForSignTypedDataLegacy({\n      data: typedData\n    });\n    const typedDataJSON = JSON.stringify(typedData, null, 2);\n    return this._signEthereumMessage(message, address, false, typedDataJSON);\n  }\n\n  async _eth_signTypedData_v3(params) {\n    this._requireAuthorization();\n\n    const address = util_1.ensureAddressString(params[0]);\n    const typedData = util_1.ensureParsedJSONObject(params[1]);\n\n    this._ensureKnownAddress(address);\n\n    const message = eth_eip712_util_1.default.hashForSignTypedData_v3({\n      data: typedData\n    });\n    const typedDataJSON = JSON.stringify(typedData, null, 2);\n    return this._signEthereumMessage(message, address, false, typedDataJSON);\n  }\n\n  async _eth_signTypedData_v4(params) {\n    this._requireAuthorization();\n\n    const address = util_1.ensureAddressString(params[0]);\n    const typedData = util_1.ensureParsedJSONObject(params[1]);\n\n    this._ensureKnownAddress(address);\n\n    const message = eth_eip712_util_1.default.hashForSignTypedData_v4({\n      data: typedData\n    });\n    const typedDataJSON = JSON.stringify(typedData, null, 2);\n    return this._signEthereumMessage(message, address, false, typedDataJSON);\n  }\n\n  async _walletlink_arbitrary(params) {\n    const data = params[0];\n\n    if (typeof data !== \"string\") {\n      throw new Error(\"parameter must be a string\");\n    }\n\n    const result = await this.arbitraryRequest(data);\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result\n    };\n  }\n\n  _eth_uninstallFilter(params) {\n    const filterId = util_1.ensureHexString(params[0]);\n    return this._filterPolyfill.uninstallFilter(filterId);\n  }\n\n  async _eth_newFilter(params) {\n    const param = params[0];\n    const filterId = await this._filterPolyfill.newFilter(param);\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: filterId\n    };\n  }\n\n  async _eth_newBlockFilter() {\n    const filterId = await this._filterPolyfill.newBlockFilter();\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: filterId\n    };\n  }\n\n  async _eth_newPendingTransactionFilter() {\n    const filterId = await this._filterPolyfill.newPendingTransactionFilter();\n    return {\n      jsonrpc: \"2.0\",\n      id: 0,\n      result: filterId\n    };\n  }\n\n  _eth_getFilterChanges(params) {\n    const filterId = util_1.ensureHexString(params[0]);\n    return this._filterPolyfill.getFilterChanges(filterId);\n  }\n\n  _eth_getFilterLogs(params) {\n    const filterId = util_1.ensureHexString(params[0]);\n    return this._filterPolyfill.getFilterLogs(filterId);\n  }\n\n  initializeRelay() {\n    if (this._relay) {\n      return Promise.resolve(this._relay);\n    }\n\n    return this._relayProvider().then(relay => {\n      relay.setChainIdCallback(chainId => {\n        this.updateProviderInfo(this._jsonRpcUrl, parseInt(chainId, 10), true);\n      });\n      relay.setJsonRpcUrlCallback(jsonRpcUrl => {\n        this.updateProviderInfo(jsonRpcUrl, this._chainId, true);\n      });\n      this._relay = relay;\n      return relay;\n    });\n  }\n\n}\n\nexports.WalletLinkProvider = WalletLinkProvider;","map":{"version":3,"sources":["/Users/sidshekhar/Documents/interface/node_modules/walletlink/dist/provider/WalletLinkProvider.js"],"names":["__importDefault","mod","__esModule","Object","defineProperty","exports","value","WalletLinkProvider","bn_js_1","require","util_1","eth_eip712_util_1","FilterPolyfill_1","JSONRPC_1","eth_rpc_errors_1","safe_event_emitter_1","SubscriptionManager_1","LOCAL_STORAGE_ADDRESSES_KEY","default","constructor","options","_filterPolyfill","FilterPolyfill","_subscriptionManager","SubscriptionManager","_relay","_addresses","hasMadeFirstChainChangedEmission","isChainOverridden","_send","send","_sendAsync","sendAsync","setProviderInfo","bind","updateProviderInfo","setAppInfo","enable","close","request","_setAddresses","scanQRCode","arbitraryRequest","childRequestEthereumAccounts","_chainId","ensureIntNumber","chainId","_jsonRpcUrl","jsonRpcUrl","_overrideIsMetaMask","overrideIsMetaMask","_relayProvider","relayProvider","_storage","storage","_relayEventManager","relayEventManager","chainIdStr","prepend0x","toString","emit","cachedAddresses","getItem","addresses","split","events","on","notification","type","method","data","params","length","initializeRelay","selectedAddress","undefined","networkVersion","isWalletLink","isMetaMask","host","connected","isConnected","fromRelay","originalChainId","chainChanged","appName","appLogoUrl","then","relay","JSONRPCMethod","eth_requestAccounts","resetAndReload","requestOrMethod","callbackOrParams","Array","isArray","jsonrpc","id","_sendRequestAsync","res","result","callback","requests","map","r","_sendRequest","req","Error","arrayCb","_sendMultipleRequestsAsync","responses","catch","err","cb","response","args","ethErrors","rpc","invalidRequest","message","newParams","makeRequestId","match","ensureRegExpString","childSessionId","childSessionSecret","dappName","dappLogoURL","dappURL","supportsSubscriptions","subscribe","unsubscribe","disconnect","_handleSynchronousMethods","address","ensureAddressString","setItem","join","window","dispatchEvent","CustomEvent","detail","Promise","resolve","reject","syncResult","filterPromise","_handleAsynchronousFilterMethods","assign","subscriptionPromise","_handleSubscriptionMethods","_handleAsynchronousMethods","all","eth_accounts","_eth_accounts","eth_coinbase","_eth_coinbase","eth_uninstallFilter","_eth_uninstallFilter","net_version","_net_version","eth_chainId","_eth_chainId","_eth_requestAccounts","eth_sign","_eth_sign","eth_ecRecover","_eth_ecRecover","personal_sign","_personal_sign","personal_ecRecover","_personal_ecRecover","eth_signTransaction","_eth_signTransaction","eth_sendRawTransaction","_eth_sendRawTransaction","eth_sendTransaction","_eth_sendTransaction","eth_signTypedData_v1","_eth_signTypedData_v1","eth_signTypedData_v2","_throwUnsupportedMethodError","eth_signTypedData_v3","_eth_signTypedData_v3","eth_signTypedData_v4","eth_signTypedData","_eth_signTypedData_v4","walletlink_arbitrary","_walletlink_arbitrary","fetch","body","JSON","stringify","mode","headers","json","parse","error","serializeError","eth_newFilter","_eth_newFilter","eth_newBlockFilter","_eth_newBlockFilter","eth_newPendingTransactionFilter","_eth_newPendingTransactionFilter","eth_getFilterChanges","_eth_getFilterChanges","eth_getFilterLogs","_eth_getFilterLogs","eth_subscribe","eth_unsubscribe","handleRequest","_isKnownAddress","addressString","includes","_a","_ensureKnownAddress","_prepareTransactionParams","tx","fromAddress","from","toAddress","to","weiValue","ensureBN","ensureBuffer","Buffer","alloc","nonce","gasPriceInWei","gasPrice","gasLimit","gas","_requireAuthorization","provider","unauthorized","unsupportedMethod","_signEthereumMessage","addPrefix","typedDataJson","signEthereumMessage","userRejectedRequest","_ethereumAddressFromSignedMessage","signature","ethereumAddressFromSignedMessage","hexStringFromIntNumber","requestEthereumAccounts","signEthereumTransaction","signedTransaction","submitEthereumTransaction","signAndSubmitEthereumTransaction","typedData","ensureParsedJSONObject","hashForSignTypedDataLegacy","typedDataJSON","hashForSignTypedData_v3","hashForSignTypedData_v4","filterId","ensureHexString","uninstallFilter","param","newFilter","newBlockFilter","newPendingTransactionFilter","getFilterChanges","getFilterLogs","setChainIdCallback","parseInt","setJsonRpcUrlCallback"],"mappings":"AAAA,a,CACA;AACA;AACA;;AACA,IAAIA,eAAe,GAAI,QAAQ,KAAKA,eAAd,IAAkC,UAAUC,GAAV,EAAe;AACnE,SAAQA,GAAG,IAAIA,GAAG,CAACC,UAAZ,GAA0BD,GAA1B,GAAgC;AAAE,eAAWA;AAAb,GAAvC;AACH,CAFD;;AAGAE,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEC,EAAAA,KAAK,EAAE;AAAT,CAA7C;AACAD,OAAO,CAACE,kBAAR,GAA6B,KAAK,CAAlC;;AACA,MAAMC,OAAO,GAAGR,eAAe,CAACS,OAAO,CAAC,OAAD,CAAR,CAA/B;;AACA,MAAMC,MAAM,GAAGD,OAAO,CAAC,SAAD,CAAtB;;AACA,MAAME,iBAAiB,GAAGX,eAAe,CAACS,OAAO,CAAC,8BAAD,CAAR,CAAzC;;AACA,MAAMG,gBAAgB,GAAGH,OAAO,CAAC,kBAAD,CAAhC;;AACA,MAAMI,SAAS,GAAGJ,OAAO,CAAC,WAAD,CAAzB;;AACA,MAAMK,gBAAgB,GAAGL,OAAO,CAAC,gBAAD,CAAhC;;AACA,MAAMM,oBAAoB,GAAGf,eAAe,CAACS,OAAO,CAAC,8BAAD,CAAR,CAA5C;;AACA,MAAMO,qBAAqB,GAAGP,OAAO,CAAC,uBAAD,CAArC;;AACA,MAAMQ,2BAA2B,GAAG,WAApC;;AACA,MAAMV,kBAAN,SAAiCQ,oBAAoB,CAACG,OAAtD,CAA8D;AAC1DC,EAAAA,WAAW,CAACC,OAAD,EAAU;AACjB;AACA,SAAKC,eAAL,GAAuB,IAAIT,gBAAgB,CAACU,cAArB,CAAoC,IAApC,CAAvB;AACA,SAAKC,oBAAL,GAA4B,IAAIP,qBAAqB,CAACQ,mBAA1B,CAA8C,IAA9C,CAA5B;AACA,SAAKC,MAAL,GAAc,IAAd;AACA,SAAKC,UAAL,GAAkB,EAAlB;AACA,SAAKC,gCAAL,GAAwC,KAAxC,CANiB,CAOjB;;AACA,SAAKC,iBAAL,GAAyB,KAAzB;AACA,SAAKC,KAAL,GAAa,KAAKC,IAAlB;AACA,SAAKC,UAAL,GAAkB,KAAKC,SAAvB;AACA,SAAKC,eAAL,GAAuB,KAAKA,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAAvB;AACA,SAAKC,kBAAL,GAA0B,KAAKA,kBAAL,CAAwBD,IAAxB,CAA6B,IAA7B,CAA1B;AACA,SAAKE,UAAL,GAAkB,KAAKA,UAAL,CAAgBF,IAAhB,CAAqB,IAArB,CAAlB;AACA,SAAKG,MAAL,GAAc,KAAKA,MAAL,CAAYH,IAAZ,CAAiB,IAAjB,CAAd;AACA,SAAKI,KAAL,GAAa,KAAKA,KAAL,CAAWJ,IAAX,CAAgB,IAAhB,CAAb;AACA,SAAKJ,IAAL,GAAY,KAAKA,IAAL,CAAUI,IAAV,CAAe,IAAf,CAAZ;AACA,SAAKF,SAAL,GAAiB,KAAKA,SAAL,CAAeE,IAAf,CAAoB,IAApB,CAAjB;AACA,SAAKK,OAAL,GAAe,KAAKA,OAAL,CAAaL,IAAb,CAAkB,IAAlB,CAAf;AACA,SAAKM,aAAL,GAAqB,KAAKA,aAAL,CAAmBN,IAAnB,CAAwB,IAAxB,CAArB;AACA,SAAKO,UAAL,GAAkB,KAAKA,UAAL,CAAgBP,IAAhB,CAAqB,IAArB,CAAlB;AACA,SAAKQ,gBAAL,GAAwB,KAAKA,gBAAL,CAAsBR,IAAtB,CAA2B,IAA3B,CAAxB;AACA,SAAKS,4BAAL,GAAoC,KAAKA,4BAAL,CAAkCT,IAAlC,CAAuC,IAAvC,CAApC;AACA,SAAKU,QAAL,GAAgBlC,MAAM,CAACmC,eAAP,CAAuBzB,OAAO,CAAC0B,OAAR,IAAmB,CAA1C,CAAhB;AACA,SAAKC,WAAL,GAAmB3B,OAAO,CAAC4B,UAA3B;AACA,SAAKC,mBAAL,GAA2B7B,OAAO,CAAC8B,kBAAnC;AACA,SAAKC,cAAL,GAAsB/B,OAAO,CAACgC,aAA9B;AACA,SAAKC,QAAL,GAAgBjC,OAAO,CAACkC,OAAxB;AACA,SAAKC,kBAAL,GAA0BnC,OAAO,CAACoC,iBAAlC;AACA,UAAMC,UAAU,GAAG/C,MAAM,CAACgD,SAAP,CAAiB,KAAKd,QAAL,CAAce,QAAd,CAAuB,EAAvB,CAAjB,CAAnB,CA7BiB,CA8BjB;;AACA,SAAKC,IAAL,CAAU,SAAV,EAAqB;AAAEH,MAAAA;AAAF,KAArB;;AACA,UAAMI,eAAe,GAAG,KAAKR,QAAL,CAAcS,OAAd,CAAsB7C,2BAAtB,CAAxB;;AACA,QAAI4C,eAAJ,EAAqB;AACjB,YAAME,SAAS,GAAGF,eAAe,CAACG,KAAhB,CAAsB,GAAtB,CAAlB;;AACA,UAAID,SAAS,CAAC,CAAD,CAAT,KAAiB,EAArB,EAAyB;AACrB,aAAKrC,UAAL,GAAkBqC,SAAlB;AACA,aAAKH,IAAL,CAAU,iBAAV,EAA6BG,SAA7B;AACH;AACJ;;AACD,SAAKxC,oBAAL,CAA0B0C,MAA1B,CAAiCC,EAAjC,CAAoC,cAApC,EAAqDC,YAAD,IAAkB;AAClE,WAAKP,IAAL,CAAU,SAAV,EAAqB;AACjBQ,QAAAA,IAAI,EAAED,YAAY,CAACE,MADF;AAEjBC,QAAAA,IAAI,EAAEH,YAAY,CAACI;AAFF,OAArB;AAIH,KALD;;AAMA,QAAI,KAAK7C,UAAL,CAAgB8C,MAAhB,GAAyB,CAA7B,EAAgC;AAC5B,WAAKC,eAAL;AACH;AACJ;;AACD,MAAIC,eAAJ,GAAsB;AAClB,WAAO,KAAKhD,UAAL,CAAgB,CAAhB,KAAsBiD,SAA7B;AACH;;AACD,MAAIC,cAAJ,GAAqB;AACjB,WAAO,KAAKhC,QAAL,CAAce,QAAd,CAAuB,EAAvB,CAAP;AACH;;AACD,MAAIb,OAAJ,GAAc;AACV,WAAOpC,MAAM,CAACgD,SAAP,CAAiB,KAAKd,QAAL,CAAce,QAAd,CAAuB,EAAvB,CAAjB,CAAP;AACH;;AACD,MAAIkB,YAAJ,GAAmB;AACf,WAAO,IAAP;AACH;AACD;AACJ;AACA;AACA;;;AACI,MAAIC,UAAJ,GAAiB;AACb,WAAO,KAAK7B,mBAAZ;AACH;;AACD,MAAI8B,IAAJ,GAAW;AACP,WAAO,KAAKhC,WAAZ;AACH;;AACD,MAAIiC,SAAJ,GAAgB;AACZ,WAAO,IAAP;AACH;;AACDC,EAAAA,WAAW,GAAG;AACV,WAAO,IAAP;AACH;;AACDhD,EAAAA,eAAe,CAACe,UAAD,EAAaF,OAAb,EAAsB;AACjC,QAAI,KAAKlB,iBAAT,EACI;AACJ,SAAKO,kBAAL,CAAwBa,UAAxB,EAAoCF,OAApC,EAA6C,KAA7C;AACH;;AACDX,EAAAA,kBAAkB,CAACa,UAAD,EAAaF,OAAb,EAAsBoC,SAAtB,EAAiC;AAC/C,QAAIA,SAAJ,EACI,KAAKtD,iBAAL,GAAyB,IAAzB;AACJ,UAAMuD,eAAe,GAAG,KAAKvC,QAA7B;AACA,SAAKA,QAAL,GAAgBlC,MAAM,CAACmC,eAAP,CAAuBC,OAAvB,CAAhB;AACA,UAAMsC,YAAY,GAAG,KAAKxC,QAAL,KAAkBuC,eAAvC;AACA,SAAKpC,WAAL,GAAmBC,UAAnB;;AACA,QAAIoC,YAAY,IAAI,CAAC,KAAKzD,gCAA1B,EAA4D;AACxD,WAAKiC,IAAL,CAAU,cAAV,EAA0B,KAAKhB,QAA/B;AACA,WAAKjB,gCAAL,GAAwC,IAAxC;AACH;AACJ;;AACDS,EAAAA,UAAU,CAACiD,OAAD,EAAUC,UAAV,EAAsB;AAC5B,SAAKb,eAAL,GAAuBc,IAAvB,CAA4BC,KAAK,IAAIA,KAAK,CAACpD,UAAN,CAAiBiD,OAAjB,EAA0BC,UAA1B,CAArC;AACH;;AACD,QAAMjD,MAAN,GAAe;AACX,QAAI,KAAKX,UAAL,CAAgB8C,MAAhB,GAAyB,CAA7B,EAAgC;AAC5B,aAAO,KAAK9C,UAAZ;AACH;;AACD,WAAO,MAAM,KAAKG,KAAL,CAAWhB,SAAS,CAAC4E,aAAV,CAAwBC,mBAAnC,CAAb;AACH;;AACDpD,EAAAA,KAAK,GAAG;AACJ,SAAKmC,eAAL,GAAuBc,IAAvB,CAA4BC,KAAK,IAAIA,KAAK,CAACG,cAAN,EAArC;AACH;;AACD7D,EAAAA,IAAI,CAAC8D,eAAD,EAAkBC,gBAAlB,EAAoC;AACpC;AACA,QAAI,OAAOD,eAAP,KAA2B,QAA/B,EAAyC;AACrC,YAAMvB,MAAM,GAAGuB,eAAf;AACA,YAAMrB,MAAM,GAAGuB,KAAK,CAACC,OAAN,CAAcF,gBAAd,IACTA,gBADS,GAETA,gBAAgB,KAAKlB,SAArB,GACI,CAACkB,gBAAD,CADJ,GAEI,EAJV;AAKA,YAAMtD,OAAO,GAAG;AACZyD,QAAAA,OAAO,EAAE,KADG;AAEZC,QAAAA,EAAE,EAAE,CAFQ;AAGZ5B,QAAAA,MAHY;AAIZE,QAAAA;AAJY,OAAhB;AAMA,aAAO,KAAK2B,iBAAL,CAAuB3D,OAAvB,EAAgCgD,IAAhC,CAAqCY,GAAG,IAAIA,GAAG,CAACC,MAAhD,CAAP;AACH,KAhBmC,CAiBpC;;;AACA,QAAI,OAAOP,gBAAP,KAA4B,UAAhC,EAA4C;AACxC,YAAMtD,OAAO,GAAGqD,eAAhB;AACA,YAAMS,QAAQ,GAAGR,gBAAjB;AACA,aAAO,KAAK9D,UAAL,CAAgBQ,OAAhB,EAAyB8D,QAAzB,CAAP;AACH,KAtBmC,CAuBpC;;;AACA,QAAIP,KAAK,CAACC,OAAN,CAAcH,eAAd,CAAJ,EAAoC;AAChC,YAAMU,QAAQ,GAAGV,eAAjB;AACA,aAAOU,QAAQ,CAACC,GAAT,CAAaC,CAAC,IAAI,KAAKC,YAAL,CAAkBD,CAAlB,CAAlB,CAAP;AACH,KA3BmC,CA4BpC;;;AACA,UAAME,GAAG,GAAGd,eAAZ;AACA,WAAO,KAAKa,YAAL,CAAkBC,GAAlB,CAAP;AACH;;AACD1E,EAAAA,SAAS,CAACO,OAAD,EAAU8D,QAAV,EAAoB;AACzB,QAAI,OAAOA,QAAP,KAAoB,UAAxB,EAAoC;AAChC,YAAM,IAAIM,KAAJ,CAAU,sBAAV,CAAN;AACH,KAHwB,CAIzB;;;AACA,QAAIb,KAAK,CAACC,OAAN,CAAcxD,OAAd,CAAJ,EAA4B;AACxB,YAAMqE,OAAO,GAAGP,QAAhB;;AACA,WAAKQ,0BAAL,CAAgCtE,OAAhC,EACKgD,IADL,CACUuB,SAAS,IAAIF,OAAO,CAAC,IAAD,EAAOE,SAAP,CAD9B,EAEKC,KAFL,CAEWC,GAAG,IAAIJ,OAAO,CAACI,GAAD,EAAM,IAAN,CAFzB;;AAGA;AACH,KAXwB,CAYzB;;;AACA,UAAMC,EAAE,GAAGZ,QAAX;;AACA,SAAKH,iBAAL,CAAuB3D,OAAvB,EACKgD,IADL,CACU2B,QAAQ,IAAID,EAAE,CAAC,IAAD,EAAOC,QAAP,CADxB,EAEKH,KAFL,CAEWC,GAAG,IAAIC,EAAE,CAACD,GAAD,EAAM,IAAN,CAFpB;AAGH;;AACD,QAAMzE,OAAN,CAAc4E,IAAd,EAAoB;AAChB,QAAI,CAACA,IAAD,IAAS,OAAOA,IAAP,KAAgB,QAAzB,IAAqCrB,KAAK,CAACC,OAAN,CAAcoB,IAAd,CAAzC,EAA8D;AAC1D,YAAMrG,gBAAgB,CAACsG,SAAjB,CAA2BC,GAA3B,CAA+BC,cAA/B,CAA8C;AAChDC,QAAAA,OAAO,EAAE,gDADuC;AAEhDjD,QAAAA,IAAI,EAAE6C;AAF0C,OAA9C,CAAN;AAIH;;AACD,UAAM;AAAE9C,MAAAA,MAAF;AAAUE,MAAAA;AAAV,QAAqB4C,IAA3B;;AACA,QAAI,OAAO9C,MAAP,KAAkB,QAAlB,IAA8BA,MAAM,CAACG,MAAP,KAAkB,CAApD,EAAuD;AACnD,YAAM1D,gBAAgB,CAACsG,SAAjB,CAA2BC,GAA3B,CAA+BC,cAA/B,CAA8C;AAChDC,QAAAA,OAAO,EAAE,2CADuC;AAEhDjD,QAAAA,IAAI,EAAE6C;AAF0C,OAA9C,CAAN;AAIH;;AACD,QAAI5C,MAAM,KAAKI,SAAX,IACA,CAACmB,KAAK,CAACC,OAAN,CAAcxB,MAAd,CADD,KAEC,OAAOA,MAAP,KAAkB,QAAlB,IAA8BA,MAAM,KAAK,IAF1C,CAAJ,EAEqD;AACjD,YAAMzD,gBAAgB,CAACsG,SAAjB,CAA2BC,GAA3B,CAA+BC,cAA/B,CAA8C;AAChDC,QAAAA,OAAO,EAAE,uDADuC;AAEhDjD,QAAAA,IAAI,EAAE6C;AAF0C,OAA9C,CAAN;AAIH;;AACD,UAAMK,SAAS,GAAGjD,MAAM,KAAKI,SAAX,GAAuB,EAAvB,GAA4BJ,MAA9C,CAtBgB,CAuBhB;;AACA,UAAM0B,EAAE,GAAG,KAAK1C,kBAAL,CAAwBkE,aAAxB,EAAX;;AACA,UAAMrB,MAAM,GAAG,MAAM,KAAKF,iBAAL,CAAuB;AACxC7B,MAAAA,MADwC;AAExCE,MAAAA,MAAM,EAAEiD,SAFgC;AAGxCxB,MAAAA,OAAO,EAAE,KAH+B;AAIxCC,MAAAA;AAJwC,KAAvB,CAArB;AAMA,WAAOG,MAAM,CAACA,MAAd;AACH;;AACD,QAAM3D,UAAN,CAAiBiF,KAAjB,EAAwB;AACpB,UAAMlC,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,UAAM0B,GAAG,GAAG,MAAMX,KAAK,CAAC/C,UAAN,CAAiB/B,MAAM,CAACiH,kBAAP,CAA0BD,KAA1B,CAAjB,CAAlB;;AACA,QAAI,OAAOvB,GAAG,CAACC,MAAX,KAAsB,QAA1B,EAAoC;AAChC,YAAM,IAAIO,KAAJ,CAAU,yBAAV,CAAN;AACH;;AACD,WAAOR,GAAG,CAACC,MAAX;AACH;;AACD,QAAM1D,gBAAN,CAAuB4B,IAAvB,EAA6B;AACzB,UAAMkB,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,UAAM0B,GAAG,GAAG,MAAMX,KAAK,CAAC9C,gBAAN,CAAuB4B,IAAvB,CAAlB;;AACA,QAAI,OAAO6B,GAAG,CAACC,MAAX,KAAsB,QAA1B,EAAoC;AAChC,YAAM,IAAIO,KAAJ,CAAU,yBAAV,CAAN;AACH;;AACD,WAAOR,GAAG,CAACC,MAAX;AACH;;AACD,QAAMzD,4BAAN,CAAmCiF,cAAnC,EAAmDC,kBAAnD,EAAuEC,QAAvE,EAAiFC,WAAjF,EAA8FC,OAA9F,EAAuG;AACnG,UAAMxC,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,UAAMe,KAAK,CAAC7C,4BAAN,CAAmCiF,cAAnC,EAAmDC,kBAAnD,EAAuEC,QAAvE,EAAiFC,WAAjF,EAA8FC,OAA9F,CAAN;AACA,WAAO,IAAP;AACH;;AACDC,EAAAA,qBAAqB,GAAG;AACpB,WAAO,KAAP;AACH;;AACDC,EAAAA,SAAS,GAAG;AACR,UAAM,IAAIvB,KAAJ,CAAU,iCAAV,CAAN;AACH;;AACDwB,EAAAA,WAAW,GAAG;AACV,UAAM,IAAIxB,KAAJ,CAAU,iCAAV,CAAN;AACH;;AACDyB,EAAAA,UAAU,GAAG;AACT,WAAO,IAAP;AACH;;AACD3B,EAAAA,YAAY,CAAClE,OAAD,EAAU;AAClB,UAAM2E,QAAQ,GAAG;AACblB,MAAAA,OAAO,EAAE,KADI;AAEbC,MAAAA,EAAE,EAAE1D,OAAO,CAAC0D;AAFC,KAAjB;AAIA,UAAM;AAAE5B,MAAAA;AAAF,QAAa9B,OAAnB;AACA2E,IAAAA,QAAQ,CAACd,MAAT,GAAkB,KAAKiC,yBAAL,CAA+B9F,OAA/B,CAAlB;;AACA,QAAI2E,QAAQ,CAACd,MAAT,KAAoBzB,SAAxB,EAAmC;AAC/B,YAAM,IAAIgC,KAAJ,CAAW,uCAAsCtC,MAAO,yBAA9C,GACX,2DAA0DA,MAAO,GADtD,GAEX,iBAFC,CAAN;AAGH;;AACD,WAAO6C,QAAP;AACH;;AACD1E,EAAAA,aAAa,CAACuB,SAAD,EAAY;AACrB,QAAI,CAAC+B,KAAK,CAACC,OAAN,CAAchC,SAAd,CAAL,EAA+B;AAC3B,YAAM,IAAI4C,KAAJ,CAAU,2BAAV,CAAN;AACH;;AACD,SAAKjF,UAAL,GAAkBqC,SAAS,CAACwC,GAAV,CAAc+B,OAAO,IAAI5H,MAAM,CAAC6H,mBAAP,CAA2BD,OAA3B,CAAzB,CAAlB;AACA,SAAK1E,IAAL,CAAU,iBAAV,EAA6B,KAAKlC,UAAlC;;AACA,SAAK2B,QAAL,CAAcmF,OAAd,CAAsBvH,2BAAtB,EAAmD8C,SAAS,CAAC0E,IAAV,CAAe,GAAf,CAAnD;;AACAC,IAAAA,MAAM,CAACC,aAAP,CAAqB,IAAIC,WAAJ,CAAgB,sBAAhB,EAAwC;AAAEC,MAAAA,MAAM,EAAE,KAAKnH;AAAf,KAAxC,CAArB;AACH;;AACDwE,EAAAA,iBAAiB,CAAC3D,OAAD,EAAU;AACvB,WAAO,IAAIuG,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACpC,UAAI;AACA,cAAMC,UAAU,GAAG,KAAKZ,yBAAL,CAA+B9F,OAA/B,CAAnB;;AACA,YAAI0G,UAAU,KAAKtE,SAAnB,EAA8B;AAC1B,iBAAOoE,OAAO,CAAC;AACX/C,YAAAA,OAAO,EAAE,KADE;AAEXC,YAAAA,EAAE,EAAE1D,OAAO,CAAC0D,EAFD;AAGXG,YAAAA,MAAM,EAAE6C;AAHG,WAAD,CAAd;AAKH;;AACD,cAAMC,aAAa,GAAG,KAAKC,gCAAL,CAAsC5G,OAAtC,CAAtB;;AACA,YAAI2G,aAAa,KAAKvE,SAAtB,EAAiC;AAC7BuE,UAAAA,aAAa,CACR3D,IADL,CACUY,GAAG,IAAI4C,OAAO,CAAC5I,MAAM,CAACiJ,MAAP,CAAcjJ,MAAM,CAACiJ,MAAP,CAAc,EAAd,EAAkBjD,GAAlB,CAAd,EAAsC;AAAEF,YAAAA,EAAE,EAAE1D,OAAO,CAAC0D;AAAd,WAAtC,CAAD,CADxB,EAEKc,KAFL,CAEWC,GAAG,IAAIgC,MAAM,CAAChC,GAAD,CAFxB;AAGA;AACH;;AACD,cAAMqC,mBAAmB,GAAG,KAAKC,0BAAL,CAAgC/G,OAAhC,CAA5B;;AACA,YAAI8G,mBAAmB,KAAK1E,SAA5B,EAAuC;AACnC0E,UAAAA,mBAAmB,CACd9D,IADL,CACUY,GAAG,IAAI4C,OAAO,CAAC;AACrB/C,YAAAA,OAAO,EAAE,KADY;AAErBC,YAAAA,EAAE,EAAE1D,OAAO,CAAC0D,EAFS;AAGrBG,YAAAA,MAAM,EAAED,GAAG,CAACC;AAHS,WAAD,CADxB,EAMKW,KANL,CAMWC,GAAG,IAAIgC,MAAM,CAAChC,GAAD,CANxB;AAOA;AACH;AACJ,OA3BD,CA4BA,OAAOA,GAAP,EAAY;AACR,eAAOgC,MAAM,CAAChC,GAAD,CAAb;AACH;;AACD,WAAKuC,0BAAL,CAAgChH,OAAhC,EACKgD,IADL,CACUY,GAAG,IAAI4C,OAAO,CAAC5I,MAAM,CAACiJ,MAAP,CAAcjJ,MAAM,CAACiJ,MAAP,CAAc,EAAd,EAAkBjD,GAAlB,CAAd,EAAsC;AAAEF,QAAAA,EAAE,EAAE1D,OAAO,CAAC0D;AAAd,OAAtC,CAAD,CADxB,EAEKc,KAFL,CAEWC,GAAG,IAAIgC,MAAM,CAAChC,GAAD,CAFxB;AAGH,KAnCM,CAAP;AAoCH;;AACDH,EAAAA,0BAA0B,CAACP,QAAD,EAAW;AACjC,WAAOwC,OAAO,CAACU,GAAR,CAAYlD,QAAQ,CAACC,GAAT,CAAaC,CAAC,IAAI,KAAKN,iBAAL,CAAuBM,CAAvB,CAAlB,CAAZ,CAAP;AACH;;AACD6B,EAAAA,yBAAyB,CAAC9F,OAAD,EAAU;AAC/B,UAAM;AAAE8B,MAAAA;AAAF,QAAa9B,OAAnB;AACA,UAAMgC,MAAM,GAAGhC,OAAO,CAACgC,MAAR,IAAkB,EAAjC;;AACA,YAAQF,MAAR;AACI,WAAKxD,SAAS,CAAC4E,aAAV,CAAwBgE,YAA7B;AACI,eAAO,KAAKC,aAAL,EAAP;;AACJ,WAAK7I,SAAS,CAAC4E,aAAV,CAAwBkE,YAA7B;AACI,eAAO,KAAKC,aAAL,EAAP;;AACJ,WAAK/I,SAAS,CAAC4E,aAAV,CAAwBoE,mBAA7B;AACI,eAAO,KAAKC,oBAAL,CAA0BvF,MAA1B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBsE,WAA7B;AACI,eAAO,KAAKC,YAAL,EAAP;;AACJ,WAAKnJ,SAAS,CAAC4E,aAAV,CAAwBwE,WAA7B;AACI,eAAO,KAAKC,YAAL,EAAP;;AACJ;AACI,eAAOvF,SAAP;AAZR;AAcH;;AACD4E,EAAAA,0BAA0B,CAAChH,OAAD,EAAU;AAChC,UAAM;AAAE8B,MAAAA;AAAF,QAAa9B,OAAnB;AACA,UAAMgC,MAAM,GAAGhC,OAAO,CAACgC,MAAR,IAAkB,EAAjC;;AACA,YAAQF,MAAR;AACI,WAAKxD,SAAS,CAAC4E,aAAV,CAAwBC,mBAA7B;AACI,eAAO,KAAKyE,oBAAL,EAAP;;AACJ,WAAKtJ,SAAS,CAAC4E,aAAV,CAAwB2E,QAA7B;AACI,eAAO,KAAKC,SAAL,CAAe9F,MAAf,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwB6E,aAA7B;AACI,eAAO,KAAKC,cAAL,CAAoBhG,MAApB,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwB+E,aAA7B;AACI,eAAO,KAAKC,cAAL,CAAoBlG,MAApB,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBiF,kBAA7B;AACI,eAAO,KAAKC,mBAAL,CAAyBpG,MAAzB,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBmF,mBAA7B;AACI,eAAO,KAAKC,oBAAL,CAA0BtG,MAA1B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBqF,sBAA7B;AACI,eAAO,KAAKC,uBAAL,CAA6BxG,MAA7B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBuF,mBAA7B;AACI,eAAO,KAAKC,oBAAL,CAA0B1G,MAA1B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwByF,oBAA7B;AACI,eAAO,KAAKC,qBAAL,CAA2B5G,MAA3B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwB2F,oBAA7B;AACI,eAAO,KAAKC,4BAAL,EAAP;;AACJ,WAAKxK,SAAS,CAAC4E,aAAV,CAAwB6F,oBAA7B;AACI,eAAO,KAAKC,qBAAL,CAA2BhH,MAA3B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwB+F,oBAA7B;AACA,WAAK3K,SAAS,CAAC4E,aAAV,CAAwBgG,iBAA7B;AACI,eAAO,KAAKC,qBAAL,CAA2BnH,MAA3B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBkG,oBAA7B;AACI,eAAO,KAAKC,qBAAL,CAA2BrH,MAA3B,CAAP;AA3BR;;AA6BA,QAAI,CAAC,KAAKxB,WAAV,EACI,MAAM4D,KAAK,CAAC,+BAAD,CAAX;AACJ,WAAO+B,MAAM,CACRmD,KADE,CACI,KAAK9I,WADT,EACsB;AACzBsB,MAAAA,MAAM,EAAE,MADiB;AAEzByH,MAAAA,IAAI,EAAEC,IAAI,CAACC,SAAL,CAAezJ,OAAf,CAFmB;AAGzB0J,MAAAA,IAAI,EAAE,MAHmB;AAIzBC,MAAAA,OAAO,EAAE;AAAE,wBAAgB;AAAlB;AAJgB,KADtB,EAOF3G,IAPE,CAOGY,GAAG,IAAIA,GAAG,CAACgG,IAAJ,EAPV,EAQF5G,IARE,CAQG4G,IAAI,IAAI;AACd,UAAI,CAACA,IAAL,EAAW;AACP,cAAMrL,gBAAgB,CAACsG,SAAjB,CAA2BC,GAA3B,CAA+B+E,KAA/B,CAAqC,EAArC,CAAN;AACH;;AACD,YAAMlF,QAAQ,GAAGiF,IAAjB;AACA,YAAM;AAAEE,QAAAA;AAAF,UAAYnF,QAAlB;;AACA,UAAImF,KAAJ,EAAW;AACP,cAAMvL,gBAAgB,CAACwL,cAAjB,CAAgCD,KAAhC,CAAN;AACH;;AACD,aAAOnF,QAAP;AACH,KAlBM,CAAP;AAmBH;;AACDiC,EAAAA,gCAAgC,CAAC5G,OAAD,EAAU;AACtC,UAAM;AAAE8B,MAAAA;AAAF,QAAa9B,OAAnB;AACA,UAAMgC,MAAM,GAAGhC,OAAO,CAACgC,MAAR,IAAkB,EAAjC;;AACA,YAAQF,MAAR;AACI,WAAKxD,SAAS,CAAC4E,aAAV,CAAwB8G,aAA7B;AACI,eAAO,KAAKC,cAAL,CAAoBjI,MAApB,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBgH,kBAA7B;AACI,eAAO,KAAKC,mBAAL,EAAP;;AACJ,WAAK7L,SAAS,CAAC4E,aAAV,CAAwBkH,+BAA7B;AACI,eAAO,KAAKC,gCAAL,EAAP;;AACJ,WAAK/L,SAAS,CAAC4E,aAAV,CAAwBoH,oBAA7B;AACI,eAAO,KAAKC,qBAAL,CAA2BvI,MAA3B,CAAP;;AACJ,WAAK1D,SAAS,CAAC4E,aAAV,CAAwBsH,iBAA7B;AACI,eAAO,KAAKC,kBAAL,CAAwBzI,MAAxB,CAAP;AAVR;;AAYA,WAAOI,SAAP;AACH;;AACD2E,EAAAA,0BAA0B,CAAC/G,OAAD,EAAU;AAChC,YAAQA,OAAO,CAAC8B,MAAhB;AACI,WAAKxD,SAAS,CAAC4E,aAAV,CAAwBwH,aAA7B;AACA,WAAKpM,SAAS,CAAC4E,aAAV,CAAwByH,eAA7B;AACI,eAAO,KAAK3L,oBAAL,CAA0B4L,aAA1B,CAAwC5K,OAAxC,CAAP;AAHR;;AAKA,WAAOoC,SAAP;AACH;;AACDyI,EAAAA,eAAe,CAACC,aAAD,EAAgB;AAC3B,QAAI;AACA,YAAM/E,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2B8E,aAA3B,CAAhB;AACA,aAAO,KAAK3L,UAAL,CAAgB4L,QAAhB,CAAyBhF,OAAzB,CAAP;AACH,KAHD,CAIA,OAAOiF,EAAP,EAAW,CAAG;;AACd,WAAO,KAAP;AACH;;AACDC,EAAAA,mBAAmB,CAACH,aAAD,EAAgB;AAC/B,QAAI,CAAC,KAAKD,eAAL,CAAqBC,aAArB,CAAL,EAA0C;AACtC,YAAM,IAAI1G,KAAJ,CAAU,0BAAV,CAAN;AACH;AACJ;;AACD8G,EAAAA,yBAAyB,CAACC,EAAD,EAAK;AAC1B,UAAMC,WAAW,GAAGD,EAAE,CAACE,IAAH,GACdlN,MAAM,CAAC6H,mBAAP,CAA2BmF,EAAE,CAACE,IAA9B,CADc,GAEd,KAAKlJ,eAFX;;AAGA,QAAI,CAACiJ,WAAL,EAAkB;AACd,YAAM,IAAIhH,KAAJ,CAAU,iCAAV,CAAN;AACH;;AACD,SAAK6G,mBAAL,CAAyBG,WAAzB;;AACA,UAAME,SAAS,GAAGH,EAAE,CAACI,EAAH,GAAQpN,MAAM,CAAC6H,mBAAP,CAA2BmF,EAAE,CAACI,EAA9B,CAAR,GAA4C,IAA9D;AACA,UAAMC,QAAQ,GAAGL,EAAE,CAACpN,KAAH,IAAY,IAAZ,GAAmBI,MAAM,CAACsN,QAAP,CAAgBN,EAAE,CAACpN,KAAnB,CAAnB,GAA+C,IAAIE,OAAO,CAACU,OAAZ,CAAoB,CAApB,CAAhE;AACA,UAAMoD,IAAI,GAAGoJ,EAAE,CAACpJ,IAAH,GAAU5D,MAAM,CAACuN,YAAP,CAAoBP,EAAE,CAACpJ,IAAvB,CAAV,GAAyC4J,MAAM,CAACC,KAAP,CAAa,CAAb,CAAtD;AACA,UAAMC,KAAK,GAAGV,EAAE,CAACU,KAAH,IAAY,IAAZ,GAAmB1N,MAAM,CAACmC,eAAP,CAAuB6K,EAAE,CAACU,KAA1B,CAAnB,GAAsD,IAApE;AACA,UAAMC,aAAa,GAAGX,EAAE,CAACY,QAAH,IAAe,IAAf,GAAsB5N,MAAM,CAACsN,QAAP,CAAgBN,EAAE,CAACY,QAAnB,CAAtB,GAAqD,IAA3E;AACA,UAAMC,QAAQ,GAAGb,EAAE,CAACc,GAAH,IAAU,IAAV,GAAiB9N,MAAM,CAACsN,QAAP,CAAgBN,EAAE,CAACc,GAAnB,CAAjB,GAA2C,IAA5D;AACA,UAAM1L,OAAO,GAAG,KAAKF,QAArB;AACA,WAAO;AACH+K,MAAAA,WADG;AAEHE,MAAAA,SAFG;AAGHE,MAAAA,QAHG;AAIHzJ,MAAAA,IAJG;AAKH8J,MAAAA,KALG;AAMHC,MAAAA,aANG;AAOHE,MAAAA,QAPG;AAQHzL,MAAAA;AARG,KAAP;AAUH;;AACD2L,EAAAA,qBAAqB,GAAG;AACpB,QAAI,KAAK/M,UAAL,CAAgB8C,MAAhB,KAA2B,CAA/B,EAAkC;AAC9B,YAAM1D,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCC,YAApC,CAAiD,EAAjD,CAAN;AACH;AACJ;;AACDtD,EAAAA,4BAA4B,GAAG;AAC3B,UAAMvK,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCE,iBAApC,CAAsD,EAAtD,CAAN;AACH;;AACD,QAAMC,oBAAN,CAA2BtH,OAA3B,EAAoCe,OAApC,EAA6CwG,SAA7C,EAAwDC,aAAxD,EAAuE;AACnE,SAAKvB,mBAAL,CAAyBlF,OAAzB;;AACA,QAAI;AACA,YAAM9C,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,YAAM0B,GAAG,GAAG,MAAMX,KAAK,CAACwJ,mBAAN,CAA0BzH,OAA1B,EAAmCe,OAAnC,EAA4CwG,SAA5C,EAAuDC,aAAvD,CAAlB;AACA,aAAO;AAAE/I,QAAAA,OAAO,EAAE,KAAX;AAAkBC,QAAAA,EAAE,EAAE,CAAtB;AAAyBG,QAAAA,MAAM,EAAED,GAAG,CAACC;AAArC,OAAP;AACH,KAJD,CAKA,OAAOY,GAAP,EAAY;AACR,UAAI,OAAOA,GAAG,CAACO,OAAX,KAAuB,QAAvB,IACAP,GAAG,CAACO,OAAJ,CAAYG,KAAZ,CAAkB,oBAAlB,CADJ,EAC6C;AACzC,cAAM5G,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCO,mBAApC,CAAwD,+BAAxD,CAAN;AACH;;AACD,YAAMjI,GAAN;AACH;AACJ;;AACD,QAAMkI,iCAAN,CAAwC3H,OAAxC,EAAiD4H,SAAjD,EAA4DL,SAA5D,EAAuE;AACnE,UAAMtJ,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,UAAM0B,GAAG,GAAG,MAAMX,KAAK,CAAC4J,gCAAN,CAAuC7H,OAAvC,EAAgD4H,SAAhD,EAA2DL,SAA3D,CAAlB;AACA,WAAO;AAAE9I,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAED,GAAG,CAACC;AAArC,KAAP;AACH;;AACDsD,EAAAA,aAAa,GAAG;AACZ,WAAO,KAAKhI,UAAZ;AACH;;AACDkI,EAAAA,aAAa,GAAG;AACZ,WAAO,KAAKlF,eAAL,IAAwB,IAA/B;AACH;;AACDsF,EAAAA,YAAY,GAAG;AACX,WAAO,KAAKpH,QAAL,CAAce,QAAd,CAAuB,EAAvB,CAAP;AACH;;AACDuG,EAAAA,YAAY,GAAG;AACX,WAAOxJ,MAAM,CAAC2O,sBAAP,CAA8B,KAAKzM,QAAnC,CAAP;AACH;;AACD,QAAMuH,oBAAN,GAA6B;AACzB,QAAI,KAAKzI,UAAL,CAAgB8C,MAAhB,GAAyB,CAA7B,EAAgC;AAC5B,aAAOsE,OAAO,CAACC,OAAR,CAAgB;AACnB/C,QAAAA,OAAO,EAAE,KADU;AAEnBC,QAAAA,EAAE,EAAE,CAFe;AAGnBG,QAAAA,MAAM,EAAE,KAAK1E;AAHM,OAAhB,CAAP;AAKH;;AACD,QAAIyE,GAAJ;;AACA,QAAI;AACA,YAAMX,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA0B,MAAAA,GAAG,GAAG,MAAMX,KAAK,CAAC8J,uBAAN,EAAZ;AACH,KAHD,CAIA,OAAOtI,GAAP,EAAY;AACR,UAAI,OAAOA,GAAG,CAACO,OAAX,KAAuB,QAAvB,IACAP,GAAG,CAACO,OAAJ,CAAYG,KAAZ,CAAkB,oBAAlB,CADJ,EAC6C;AACzC,cAAM5G,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCO,mBAApC,CAAwD,mCAAxD,CAAN;AACH;;AACD,YAAMjI,GAAN;AACH;;AACD,QAAI,CAACb,GAAG,CAACC,MAAT,EAAiB;AACb,YAAM,IAAIO,KAAJ,CAAU,4BAAV,CAAN;AACH;;AACD,SAAKnE,aAAL,CAAmB2D,GAAG,CAACC,MAAvB;;AACA,WAAO;AAAEJ,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAE,KAAK1E;AAAtC,KAAP;AACH;;AACD2I,EAAAA,SAAS,CAAC9F,MAAD,EAAS;AACd,SAAKkK,qBAAL;;AACA,UAAMnG,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2BhE,MAAM,CAAC,CAAD,CAAjC,CAAhB;AACA,UAAMgD,OAAO,GAAG7G,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAhB;AACA,WAAO,KAAKsK,oBAAL,CAA0BtH,OAA1B,EAAmCe,OAAnC,EAA4C,KAA5C,CAAP;AACH;;AACDiC,EAAAA,cAAc,CAAChG,MAAD,EAAS;AACnB,UAAMgD,OAAO,GAAG7G,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAhB;AACA,UAAM4K,SAAS,GAAGzO,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAlB;AACA,WAAO,KAAK2K,iCAAL,CAAuC3H,OAAvC,EAAgD4H,SAAhD,EAA2D,KAA3D,CAAP;AACH;;AACD1E,EAAAA,cAAc,CAAClG,MAAD,EAAS;AACnB,SAAKkK,qBAAL;;AACA,UAAMlH,OAAO,GAAG7G,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAhB;AACA,UAAM+D,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2BhE,MAAM,CAAC,CAAD,CAAjC,CAAhB;AACA,WAAO,KAAKsK,oBAAL,CAA0BtH,OAA1B,EAAmCe,OAAnC,EAA4C,IAA5C,CAAP;AACH;;AACDqC,EAAAA,mBAAmB,CAACpG,MAAD,EAAS;AACxB,UAAMgD,OAAO,GAAG7G,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAhB;AACA,UAAM4K,SAAS,GAAGzO,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAAlB;AACA,WAAO,KAAK2K,iCAAL,CAAuC3H,OAAvC,EAAgD4H,SAAhD,EAA2D,IAA3D,CAAP;AACH;;AACD,QAAMtE,oBAAN,CAA2BtG,MAA3B,EAAmC;AAC/B,SAAKkK,qBAAL;;AACA,UAAMf,EAAE,GAAG,KAAKD,yBAAL,CAA+BlJ,MAAM,CAAC,CAAD,CAAN,IAAa,EAA5C,CAAX;;AACA,QAAI;AACA,YAAMiB,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,YAAM0B,GAAG,GAAG,MAAMX,KAAK,CAAC+J,uBAAN,CAA8B7B,EAA9B,CAAlB;AACA,aAAO;AAAE1H,QAAAA,OAAO,EAAE,KAAX;AAAkBC,QAAAA,EAAE,EAAE,CAAtB;AAAyBG,QAAAA,MAAM,EAAED,GAAG,CAACC;AAArC,OAAP;AACH,KAJD,CAKA,OAAOY,GAAP,EAAY;AACR,UAAI,OAAOA,GAAG,CAACO,OAAX,KAAuB,QAAvB,IACAP,GAAG,CAACO,OAAJ,CAAYG,KAAZ,CAAkB,oBAAlB,CADJ,EAC6C;AACzC,cAAM5G,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCO,mBAApC,CAAwD,mCAAxD,CAAN;AACH;;AACD,YAAMjI,GAAN;AACH;AACJ;;AACD,QAAM+D,uBAAN,CAA8BxG,MAA9B,EAAsC;AAClC,UAAMiL,iBAAiB,GAAG9O,MAAM,CAACuN,YAAP,CAAoB1J,MAAM,CAAC,CAAD,CAA1B,CAA1B;AACA,UAAMiB,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,UAAM0B,GAAG,GAAG,MAAMX,KAAK,CAACiK,yBAAN,CAAgCD,iBAAhC,EAAmD,KAAK5M,QAAxD,CAAlB;AACA,WAAO;AAAEoD,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAED,GAAG,CAACC;AAArC,KAAP;AACH;;AACD,QAAM6E,oBAAN,CAA2B1G,MAA3B,EAAmC;AAC/B,SAAKkK,qBAAL;;AACA,UAAMf,EAAE,GAAG,KAAKD,yBAAL,CAA+BlJ,MAAM,CAAC,CAAD,CAAN,IAAa,EAA5C,CAAX;;AACA,QAAI;AACA,YAAMiB,KAAK,GAAG,MAAM,KAAKf,eAAL,EAApB;AACA,YAAM0B,GAAG,GAAG,MAAMX,KAAK,CAACkK,gCAAN,CAAuChC,EAAvC,CAAlB;AACA,aAAO;AAAE1H,QAAAA,OAAO,EAAE,KAAX;AAAkBC,QAAAA,EAAE,EAAE,CAAtB;AAAyBG,QAAAA,MAAM,EAAED,GAAG,CAACC;AAArC,OAAP;AACH,KAJD,CAKA,OAAOY,GAAP,EAAY;AACR,UAAI,OAAOA,GAAG,CAACO,OAAX,KAAuB,QAAvB,IACAP,GAAG,CAACO,OAAJ,CAAYG,KAAZ,CAAkB,oBAAlB,CADJ,EAC6C;AACzC,cAAM5G,gBAAgB,CAACsG,SAAjB,CAA2BsH,QAA3B,CAAoCO,mBAApC,CAAwD,mCAAxD,CAAN;AACH;;AACD,YAAMjI,GAAN;AACH;AACJ;;AACD,QAAMmE,qBAAN,CAA4B5G,MAA5B,EAAoC;AAChC,SAAKkK,qBAAL;;AACA,UAAMkB,SAAS,GAAGjP,MAAM,CAACkP,sBAAP,CAA8BrL,MAAM,CAAC,CAAD,CAApC,CAAlB;AACA,UAAM+D,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2BhE,MAAM,CAAC,CAAD,CAAjC,CAAhB;;AACA,SAAKiJ,mBAAL,CAAyBlF,OAAzB;;AACA,UAAMf,OAAO,GAAG5G,iBAAiB,CAACO,OAAlB,CAA0B2O,0BAA1B,CAAqD;AAAEvL,MAAAA,IAAI,EAAEqL;AAAR,KAArD,CAAhB;AACA,UAAMG,aAAa,GAAG/D,IAAI,CAACC,SAAL,CAAe2D,SAAf,EAA0B,IAA1B,EAAgC,CAAhC,CAAtB;AACA,WAAO,KAAKd,oBAAL,CAA0BtH,OAA1B,EAAmCe,OAAnC,EAA4C,KAA5C,EAAmDwH,aAAnD,CAAP;AACH;;AACD,QAAMvE,qBAAN,CAA4BhH,MAA5B,EAAoC;AAChC,SAAKkK,qBAAL;;AACA,UAAMnG,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2BhE,MAAM,CAAC,CAAD,CAAjC,CAAhB;AACA,UAAMoL,SAAS,GAAGjP,MAAM,CAACkP,sBAAP,CAA8BrL,MAAM,CAAC,CAAD,CAApC,CAAlB;;AACA,SAAKiJ,mBAAL,CAAyBlF,OAAzB;;AACA,UAAMf,OAAO,GAAG5G,iBAAiB,CAACO,OAAlB,CAA0B6O,uBAA1B,CAAkD;AAAEzL,MAAAA,IAAI,EAAEqL;AAAR,KAAlD,CAAhB;AACA,UAAMG,aAAa,GAAG/D,IAAI,CAACC,SAAL,CAAe2D,SAAf,EAA0B,IAA1B,EAAgC,CAAhC,CAAtB;AACA,WAAO,KAAKd,oBAAL,CAA0BtH,OAA1B,EAAmCe,OAAnC,EAA4C,KAA5C,EAAmDwH,aAAnD,CAAP;AACH;;AACD,QAAMpE,qBAAN,CAA4BnH,MAA5B,EAAoC;AAChC,SAAKkK,qBAAL;;AACA,UAAMnG,OAAO,GAAG5H,MAAM,CAAC6H,mBAAP,CAA2BhE,MAAM,CAAC,CAAD,CAAjC,CAAhB;AACA,UAAMoL,SAAS,GAAGjP,MAAM,CAACkP,sBAAP,CAA8BrL,MAAM,CAAC,CAAD,CAApC,CAAlB;;AACA,SAAKiJ,mBAAL,CAAyBlF,OAAzB;;AACA,UAAMf,OAAO,GAAG5G,iBAAiB,CAACO,OAAlB,CAA0B8O,uBAA1B,CAAkD;AAAE1L,MAAAA,IAAI,EAAEqL;AAAR,KAAlD,CAAhB;AACA,UAAMG,aAAa,GAAG/D,IAAI,CAACC,SAAL,CAAe2D,SAAf,EAA0B,IAA1B,EAAgC,CAAhC,CAAtB;AACA,WAAO,KAAKd,oBAAL,CAA0BtH,OAA1B,EAAmCe,OAAnC,EAA4C,KAA5C,EAAmDwH,aAAnD,CAAP;AACH;;AACD,QAAMlE,qBAAN,CAA4BrH,MAA5B,EAAoC;AAChC,UAAMD,IAAI,GAAGC,MAAM,CAAC,CAAD,CAAnB;;AACA,QAAI,OAAOD,IAAP,KAAgB,QAApB,EAA8B;AAC1B,YAAM,IAAIqC,KAAJ,CAAU,4BAAV,CAAN;AACH;;AACD,UAAMP,MAAM,GAAG,MAAM,KAAK1D,gBAAL,CAAsB4B,IAAtB,CAArB;AACA,WAAO;AAAE0B,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA;AAAzB,KAAP;AACH;;AACD0D,EAAAA,oBAAoB,CAACvF,MAAD,EAAS;AACzB,UAAM0L,QAAQ,GAAGvP,MAAM,CAACwP,eAAP,CAAuB3L,MAAM,CAAC,CAAD,CAA7B,CAAjB;AACA,WAAO,KAAKlD,eAAL,CAAqB8O,eAArB,CAAqCF,QAArC,CAAP;AACH;;AACD,QAAMzD,cAAN,CAAqBjI,MAArB,EAA6B;AACzB,UAAM6L,KAAK,GAAG7L,MAAM,CAAC,CAAD,CAApB;AACA,UAAM0L,QAAQ,GAAG,MAAM,KAAK5O,eAAL,CAAqBgP,SAArB,CAA+BD,KAA/B,CAAvB;AACA,WAAO;AAAEpK,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAE6J;AAAjC,KAAP;AACH;;AACD,QAAMvD,mBAAN,GAA4B;AACxB,UAAMuD,QAAQ,GAAG,MAAM,KAAK5O,eAAL,CAAqBiP,cAArB,EAAvB;AACA,WAAO;AAAEtK,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAE6J;AAAjC,KAAP;AACH;;AACD,QAAMrD,gCAAN,GAAyC;AACrC,UAAMqD,QAAQ,GAAG,MAAM,KAAK5O,eAAL,CAAqBkP,2BAArB,EAAvB;AACA,WAAO;AAAEvK,MAAAA,OAAO,EAAE,KAAX;AAAkBC,MAAAA,EAAE,EAAE,CAAtB;AAAyBG,MAAAA,MAAM,EAAE6J;AAAjC,KAAP;AACH;;AACDnD,EAAAA,qBAAqB,CAACvI,MAAD,EAAS;AAC1B,UAAM0L,QAAQ,GAAGvP,MAAM,CAACwP,eAAP,CAAuB3L,MAAM,CAAC,CAAD,CAA7B,CAAjB;AACA,WAAO,KAAKlD,eAAL,CAAqBmP,gBAArB,CAAsCP,QAAtC,CAAP;AACH;;AACDjD,EAAAA,kBAAkB,CAACzI,MAAD,EAAS;AACvB,UAAM0L,QAAQ,GAAGvP,MAAM,CAACwP,eAAP,CAAuB3L,MAAM,CAAC,CAAD,CAA7B,CAAjB;AACA,WAAO,KAAKlD,eAAL,CAAqBoP,aAArB,CAAmCR,QAAnC,CAAP;AACH;;AACDxL,EAAAA,eAAe,GAAG;AACd,QAAI,KAAKhD,MAAT,EAAiB;AACb,aAAOqH,OAAO,CAACC,OAAR,CAAgB,KAAKtH,MAArB,CAAP;AACH;;AACD,WAAO,KAAK0B,cAAL,GAAsBoC,IAAtB,CAA2BC,KAAK,IAAI;AACvCA,MAAAA,KAAK,CAACkL,kBAAN,CAA0B5N,OAAD,IAAa;AAClC,aAAKX,kBAAL,CAAwB,KAAKY,WAA7B,EAA0C4N,QAAQ,CAAC7N,OAAD,EAAU,EAAV,CAAlD,EAAiE,IAAjE;AACH,OAFD;AAGA0C,MAAAA,KAAK,CAACoL,qBAAN,CAA6B5N,UAAD,IAAgB;AACxC,aAAKb,kBAAL,CAAwBa,UAAxB,EAAoC,KAAKJ,QAAzC,EAAmD,IAAnD;AACH,OAFD;AAGA,WAAKnB,MAAL,GAAc+D,KAAd;AACA,aAAOA,KAAP;AACH,KATM,CAAP;AAUH;;AAhnByD;;AAknB9DnF,OAAO,CAACE,kBAAR,GAA6BA,kBAA7B","sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WalletLinkProvider = void 0;\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\nconst util_1 = require(\"../util\");\nconst eth_eip712_util_1 = __importDefault(require(\"../vendor-js/eth-eip712-util\"));\nconst FilterPolyfill_1 = require(\"./FilterPolyfill\");\nconst JSONRPC_1 = require(\"./JSONRPC\");\nconst eth_rpc_errors_1 = require(\"eth-rpc-errors\");\nconst safe_event_emitter_1 = __importDefault(require(\"@metamask/safe-event-emitter\"));\nconst SubscriptionManager_1 = require(\"./SubscriptionManager\");\nconst LOCAL_STORAGE_ADDRESSES_KEY = \"Addresses\";\nclass WalletLinkProvider extends safe_event_emitter_1.default {\n    constructor(options) {\n        super();\n        this._filterPolyfill = new FilterPolyfill_1.FilterPolyfill(this);\n        this._subscriptionManager = new SubscriptionManager_1.SubscriptionManager(this);\n        this._relay = null;\n        this._addresses = [];\n        this.hasMadeFirstChainChangedEmission = false;\n        // true if mobile client has sent message to override jsonRpcUrl+chainId\n        this.isChainOverridden = false;\n        this._send = this.send;\n        this._sendAsync = this.sendAsync;\n        this.setProviderInfo = this.setProviderInfo.bind(this);\n        this.updateProviderInfo = this.updateProviderInfo.bind(this);\n        this.setAppInfo = this.setAppInfo.bind(this);\n        this.enable = this.enable.bind(this);\n        this.close = this.close.bind(this);\n        this.send = this.send.bind(this);\n        this.sendAsync = this.sendAsync.bind(this);\n        this.request = this.request.bind(this);\n        this._setAddresses = this._setAddresses.bind(this);\n        this.scanQRCode = this.scanQRCode.bind(this);\n        this.arbitraryRequest = this.arbitraryRequest.bind(this);\n        this.childRequestEthereumAccounts = this.childRequestEthereumAccounts.bind(this);\n        this._chainId = util_1.ensureIntNumber(options.chainId || 1);\n        this._jsonRpcUrl = options.jsonRpcUrl;\n        this._overrideIsMetaMask = options.overrideIsMetaMask;\n        this._relayProvider = options.relayProvider;\n        this._storage = options.storage;\n        this._relayEventManager = options.relayEventManager;\n        const chainIdStr = util_1.prepend0x(this._chainId.toString(16));\n        // indicate that we've connected, for EIP-1193 compliance\n        this.emit(\"connect\", { chainIdStr });\n        const cachedAddresses = this._storage.getItem(LOCAL_STORAGE_ADDRESSES_KEY);\n        if (cachedAddresses) {\n            const addresses = cachedAddresses.split(\" \");\n            if (addresses[0] !== \"\") {\n                this._addresses = addresses;\n                this.emit(\"accountsChanged\", addresses);\n            }\n        }\n        this._subscriptionManager.events.on(\"notification\", (notification) => {\n            this.emit(\"message\", {\n                type: notification.method,\n                data: notification.params\n            });\n        });\n        if (this._addresses.length > 0) {\n            this.initializeRelay();\n        }\n    }\n    get selectedAddress() {\n        return this._addresses[0] || undefined;\n    }\n    get networkVersion() {\n        return this._chainId.toString(10);\n    }\n    get chainId() {\n        return util_1.prepend0x(this._chainId.toString(16));\n    }\n    get isWalletLink() {\n        return true;\n    }\n    /**\n     * Some DApps (i.e. Alpha Homora) seem to require the window.ethereum object return\n     * true for this method.\n     */\n    get isMetaMask() {\n        return this._overrideIsMetaMask;\n    }\n    get host() {\n        return this._jsonRpcUrl;\n    }\n    get connected() {\n        return true;\n    }\n    isConnected() {\n        return true;\n    }\n    setProviderInfo(jsonRpcUrl, chainId) {\n        if (this.isChainOverridden)\n            return;\n        this.updateProviderInfo(jsonRpcUrl, chainId, false);\n    }\n    updateProviderInfo(jsonRpcUrl, chainId, fromRelay) {\n        if (fromRelay)\n            this.isChainOverridden = true;\n        const originalChainId = this._chainId;\n        this._chainId = util_1.ensureIntNumber(chainId);\n        const chainChanged = this._chainId !== originalChainId;\n        this._jsonRpcUrl = jsonRpcUrl;\n        if (chainChanged || !this.hasMadeFirstChainChangedEmission) {\n            this.emit(\"chainChanged\", this._chainId);\n            this.hasMadeFirstChainChangedEmission = true;\n        }\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.initializeRelay().then(relay => relay.setAppInfo(appName, appLogoUrl));\n    }\n    async enable() {\n        if (this._addresses.length > 0) {\n            return this._addresses;\n        }\n        return await this._send(JSONRPC_1.JSONRPCMethod.eth_requestAccounts);\n    }\n    close() {\n        this.initializeRelay().then(relay => relay.resetAndReload());\n    }\n    send(requestOrMethod, callbackOrParams) {\n        // send<T>(method, params): Promise<T>\n        if (typeof requestOrMethod === \"string\") {\n            const method = requestOrMethod;\n            const params = Array.isArray(callbackOrParams)\n                ? callbackOrParams\n                : callbackOrParams !== undefined\n                    ? [callbackOrParams]\n                    : [];\n            const request = {\n                jsonrpc: \"2.0\",\n                id: 0,\n                method,\n                params\n            };\n            return this._sendRequestAsync(request).then(res => res.result);\n        }\n        // send(JSONRPCRequest | JSONRPCRequest[], callback): void\n        if (typeof callbackOrParams === \"function\") {\n            const request = requestOrMethod;\n            const callback = callbackOrParams;\n            return this._sendAsync(request, callback);\n        }\n        // send(JSONRPCRequest[]): JSONRPCResponse[]\n        if (Array.isArray(requestOrMethod)) {\n            const requests = requestOrMethod;\n            return requests.map(r => this._sendRequest(r));\n        }\n        // send(JSONRPCRequest): JSONRPCResponse\n        const req = requestOrMethod;\n        return this._sendRequest(req);\n    }\n    sendAsync(request, callback) {\n        if (typeof callback !== \"function\") {\n            throw new Error(\"callback is required\");\n        }\n        // send(JSONRPCRequest[], callback): void\n        if (Array.isArray(request)) {\n            const arrayCb = callback;\n            this._sendMultipleRequestsAsync(request)\n                .then(responses => arrayCb(null, responses))\n                .catch(err => arrayCb(err, null));\n            return;\n        }\n        // send(JSONRPCRequest, callback): void\n        const cb = callback;\n        this._sendRequestAsync(request)\n            .then(response => cb(null, response))\n            .catch(err => cb(err, null));\n    }\n    async request(args) {\n        if (!args || typeof args !== \"object\" || Array.isArray(args)) {\n            throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n                message: \"Expected a single, non-array, object argument.\",\n                data: args\n            });\n        }\n        const { method, params } = args;\n        if (typeof method !== \"string\" || method.length === 0) {\n            throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n                message: \"'args.method' must be a non-empty string.\",\n                data: args\n            });\n        }\n        if (params !== undefined &&\n            !Array.isArray(params) &&\n            (typeof params !== \"object\" || params === null)) {\n            throw eth_rpc_errors_1.ethErrors.rpc.invalidRequest({\n                message: \"'args.params' must be an object or array if provided.\",\n                data: args\n            });\n        }\n        const newParams = params === undefined ? [] : params;\n        // WalletLink Requests\n        const id = this._relayEventManager.makeRequestId();\n        const result = await this._sendRequestAsync({\n            method,\n            params: newParams,\n            jsonrpc: \"2.0\",\n            id\n        });\n        return result.result;\n    }\n    async scanQRCode(match) {\n        const relay = await this.initializeRelay();\n        const res = await relay.scanQRCode(util_1.ensureRegExpString(match));\n        if (typeof res.result !== \"string\") {\n            throw new Error(\"result was not a string\");\n        }\n        return res.result;\n    }\n    async arbitraryRequest(data) {\n        const relay = await this.initializeRelay();\n        const res = await relay.arbitraryRequest(data);\n        if (typeof res.result !== \"string\") {\n            throw new Error(\"result was not a string\");\n        }\n        return res.result;\n    }\n    async childRequestEthereumAccounts(childSessionId, childSessionSecret, dappName, dappLogoURL, dappURL) {\n        const relay = await this.initializeRelay();\n        await relay.childRequestEthereumAccounts(childSessionId, childSessionSecret, dappName, dappLogoURL, dappURL);\n        return true;\n    }\n    supportsSubscriptions() {\n        return false;\n    }\n    subscribe() {\n        throw new Error(\"Subscriptions are not supported\");\n    }\n    unsubscribe() {\n        throw new Error(\"Subscriptions are not supported\");\n    }\n    disconnect() {\n        return true;\n    }\n    _sendRequest(request) {\n        const response = {\n            jsonrpc: \"2.0\",\n            id: request.id\n        };\n        const { method } = request;\n        response.result = this._handleSynchronousMethods(request);\n        if (response.result === undefined) {\n            throw new Error(`WalletLink does not support calling ${method} synchronously without ` +\n                `a callback. Please provide a callback parameter to call ${method} ` +\n                `asynchronously.`);\n        }\n        return response;\n    }\n    _setAddresses(addresses) {\n        if (!Array.isArray(addresses)) {\n            throw new Error(\"addresses is not an array\");\n        }\n        this._addresses = addresses.map(address => util_1.ensureAddressString(address));\n        this.emit(\"accountsChanged\", this._addresses);\n        this._storage.setItem(LOCAL_STORAGE_ADDRESSES_KEY, addresses.join(\" \"));\n        window.dispatchEvent(new CustomEvent(\"walletlink:addresses\", { detail: this._addresses }));\n    }\n    _sendRequestAsync(request) {\n        return new Promise((resolve, reject) => {\n            try {\n                const syncResult = this._handleSynchronousMethods(request);\n                if (syncResult !== undefined) {\n                    return resolve({\n                        jsonrpc: \"2.0\",\n                        id: request.id,\n                        result: syncResult\n                    });\n                }\n                const filterPromise = this._handleAsynchronousFilterMethods(request);\n                if (filterPromise !== undefined) {\n                    filterPromise\n                        .then(res => resolve(Object.assign(Object.assign({}, res), { id: request.id })))\n                        .catch(err => reject(err));\n                    return;\n                }\n                const subscriptionPromise = this._handleSubscriptionMethods(request);\n                if (subscriptionPromise !== undefined) {\n                    subscriptionPromise\n                        .then(res => resolve({\n                        jsonrpc: \"2.0\",\n                        id: request.id,\n                        result: res.result\n                    }))\n                        .catch(err => reject(err));\n                    return;\n                }\n            }\n            catch (err) {\n                return reject(err);\n            }\n            this._handleAsynchronousMethods(request)\n                .then(res => resolve(Object.assign(Object.assign({}, res), { id: request.id })))\n                .catch(err => reject(err));\n        });\n    }\n    _sendMultipleRequestsAsync(requests) {\n        return Promise.all(requests.map(r => this._sendRequestAsync(r)));\n    }\n    _handleSynchronousMethods(request) {\n        const { method } = request;\n        const params = request.params || [];\n        switch (method) {\n            case JSONRPC_1.JSONRPCMethod.eth_accounts:\n                return this._eth_accounts();\n            case JSONRPC_1.JSONRPCMethod.eth_coinbase:\n                return this._eth_coinbase();\n            case JSONRPC_1.JSONRPCMethod.eth_uninstallFilter:\n                return this._eth_uninstallFilter(params);\n            case JSONRPC_1.JSONRPCMethod.net_version:\n                return this._net_version();\n            case JSONRPC_1.JSONRPCMethod.eth_chainId:\n                return this._eth_chainId();\n            default:\n                return undefined;\n        }\n    }\n    _handleAsynchronousMethods(request) {\n        const { method } = request;\n        const params = request.params || [];\n        switch (method) {\n            case JSONRPC_1.JSONRPCMethod.eth_requestAccounts:\n                return this._eth_requestAccounts();\n            case JSONRPC_1.JSONRPCMethod.eth_sign:\n                return this._eth_sign(params);\n            case JSONRPC_1.JSONRPCMethod.eth_ecRecover:\n                return this._eth_ecRecover(params);\n            case JSONRPC_1.JSONRPCMethod.personal_sign:\n                return this._personal_sign(params);\n            case JSONRPC_1.JSONRPCMethod.personal_ecRecover:\n                return this._personal_ecRecover(params);\n            case JSONRPC_1.JSONRPCMethod.eth_signTransaction:\n                return this._eth_signTransaction(params);\n            case JSONRPC_1.JSONRPCMethod.eth_sendRawTransaction:\n                return this._eth_sendRawTransaction(params);\n            case JSONRPC_1.JSONRPCMethod.eth_sendTransaction:\n                return this._eth_sendTransaction(params);\n            case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v1:\n                return this._eth_signTypedData_v1(params);\n            case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v2:\n                return this._throwUnsupportedMethodError();\n            case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v3:\n                return this._eth_signTypedData_v3(params);\n            case JSONRPC_1.JSONRPCMethod.eth_signTypedData_v4:\n            case JSONRPC_1.JSONRPCMethod.eth_signTypedData:\n                return this._eth_signTypedData_v4(params);\n            case JSONRPC_1.JSONRPCMethod.walletlink_arbitrary:\n                return this._walletlink_arbitrary(params);\n        }\n        if (!this._jsonRpcUrl)\n            throw Error(\"Error: No jsonRpcUrl provided\");\n        return window\n            .fetch(this._jsonRpcUrl, {\n            method: \"POST\",\n            body: JSON.stringify(request),\n            mode: \"cors\",\n            headers: { \"Content-Type\": \"application/json\" }\n        })\n            .then(res => res.json())\n            .then(json => {\n            if (!json) {\n                throw eth_rpc_errors_1.ethErrors.rpc.parse({});\n            }\n            const response = json;\n            const { error } = response;\n            if (error) {\n                throw eth_rpc_errors_1.serializeError(error);\n            }\n            return response;\n        });\n    }\n    _handleAsynchronousFilterMethods(request) {\n        const { method } = request;\n        const params = request.params || [];\n        switch (method) {\n            case JSONRPC_1.JSONRPCMethod.eth_newFilter:\n                return this._eth_newFilter(params);\n            case JSONRPC_1.JSONRPCMethod.eth_newBlockFilter:\n                return this._eth_newBlockFilter();\n            case JSONRPC_1.JSONRPCMethod.eth_newPendingTransactionFilter:\n                return this._eth_newPendingTransactionFilter();\n            case JSONRPC_1.JSONRPCMethod.eth_getFilterChanges:\n                return this._eth_getFilterChanges(params);\n            case JSONRPC_1.JSONRPCMethod.eth_getFilterLogs:\n                return this._eth_getFilterLogs(params);\n        }\n        return undefined;\n    }\n    _handleSubscriptionMethods(request) {\n        switch (request.method) {\n            case JSONRPC_1.JSONRPCMethod.eth_subscribe:\n            case JSONRPC_1.JSONRPCMethod.eth_unsubscribe:\n                return this._subscriptionManager.handleRequest(request);\n        }\n        return undefined;\n    }\n    _isKnownAddress(addressString) {\n        try {\n            const address = util_1.ensureAddressString(addressString);\n            return this._addresses.includes(address);\n        }\n        catch (_a) { }\n        return false;\n    }\n    _ensureKnownAddress(addressString) {\n        if (!this._isKnownAddress(addressString)) {\n            throw new Error(\"Unknown Ethereum address\");\n        }\n    }\n    _prepareTransactionParams(tx) {\n        const fromAddress = tx.from\n            ? util_1.ensureAddressString(tx.from)\n            : this.selectedAddress;\n        if (!fromAddress) {\n            throw new Error(\"Ethereum address is unavailable\");\n        }\n        this._ensureKnownAddress(fromAddress);\n        const toAddress = tx.to ? util_1.ensureAddressString(tx.to) : null;\n        const weiValue = tx.value != null ? util_1.ensureBN(tx.value) : new bn_js_1.default(0);\n        const data = tx.data ? util_1.ensureBuffer(tx.data) : Buffer.alloc(0);\n        const nonce = tx.nonce != null ? util_1.ensureIntNumber(tx.nonce) : null;\n        const gasPriceInWei = tx.gasPrice != null ? util_1.ensureBN(tx.gasPrice) : null;\n        const gasLimit = tx.gas != null ? util_1.ensureBN(tx.gas) : null;\n        const chainId = this._chainId;\n        return {\n            fromAddress,\n            toAddress,\n            weiValue,\n            data,\n            nonce,\n            gasPriceInWei,\n            gasLimit,\n            chainId\n        };\n    }\n    _requireAuthorization() {\n        if (this._addresses.length === 0) {\n            throw eth_rpc_errors_1.ethErrors.provider.unauthorized({});\n        }\n    }\n    _throwUnsupportedMethodError() {\n        throw eth_rpc_errors_1.ethErrors.provider.unsupportedMethod({});\n    }\n    async _signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        this._ensureKnownAddress(address);\n        try {\n            const relay = await this.initializeRelay();\n            const res = await relay.signEthereumMessage(message, address, addPrefix, typedDataJson);\n            return { jsonrpc: \"2.0\", id: 0, result: res.result };\n        }\n        catch (err) {\n            if (typeof err.message === \"string\" &&\n                err.message.match(/(denied|rejected)/i)) {\n                throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied message signature\");\n            }\n            throw err;\n        }\n    }\n    async _ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        const relay = await this.initializeRelay();\n        const res = await relay.ethereumAddressFromSignedMessage(message, signature, addPrefix);\n        return { jsonrpc: \"2.0\", id: 0, result: res.result };\n    }\n    _eth_accounts() {\n        return this._addresses;\n    }\n    _eth_coinbase() {\n        return this.selectedAddress || null;\n    }\n    _net_version() {\n        return this._chainId.toString(10);\n    }\n    _eth_chainId() {\n        return util_1.hexStringFromIntNumber(this._chainId);\n    }\n    async _eth_requestAccounts() {\n        if (this._addresses.length > 0) {\n            return Promise.resolve({\n                jsonrpc: \"2.0\",\n                id: 0,\n                result: this._addresses\n            });\n        }\n        let res;\n        try {\n            const relay = await this.initializeRelay();\n            res = await relay.requestEthereumAccounts();\n        }\n        catch (err) {\n            if (typeof err.message === \"string\" &&\n                err.message.match(/(denied|rejected)/i)) {\n                throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied account authorization\");\n            }\n            throw err;\n        }\n        if (!res.result) {\n            throw new Error(\"accounts received is empty\");\n        }\n        this._setAddresses(res.result);\n        return { jsonrpc: \"2.0\", id: 0, result: this._addresses };\n    }\n    _eth_sign(params) {\n        this._requireAuthorization();\n        const address = util_1.ensureAddressString(params[0]);\n        const message = util_1.ensureBuffer(params[1]);\n        return this._signEthereumMessage(message, address, false);\n    }\n    _eth_ecRecover(params) {\n        const message = util_1.ensureBuffer(params[0]);\n        const signature = util_1.ensureBuffer(params[1]);\n        return this._ethereumAddressFromSignedMessage(message, signature, false);\n    }\n    _personal_sign(params) {\n        this._requireAuthorization();\n        const message = util_1.ensureBuffer(params[0]);\n        const address = util_1.ensureAddressString(params[1]);\n        return this._signEthereumMessage(message, address, true);\n    }\n    _personal_ecRecover(params) {\n        const message = util_1.ensureBuffer(params[0]);\n        const signature = util_1.ensureBuffer(params[1]);\n        return this._ethereumAddressFromSignedMessage(message, signature, true);\n    }\n    async _eth_signTransaction(params) {\n        this._requireAuthorization();\n        const tx = this._prepareTransactionParams(params[0] || {});\n        try {\n            const relay = await this.initializeRelay();\n            const res = await relay.signEthereumTransaction(tx);\n            return { jsonrpc: \"2.0\", id: 0, result: res.result };\n        }\n        catch (err) {\n            if (typeof err.message === \"string\" &&\n                err.message.match(/(denied|rejected)/i)) {\n                throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied transaction signature\");\n            }\n            throw err;\n        }\n    }\n    async _eth_sendRawTransaction(params) {\n        const signedTransaction = util_1.ensureBuffer(params[0]);\n        const relay = await this.initializeRelay();\n        const res = await relay.submitEthereumTransaction(signedTransaction, this._chainId);\n        return { jsonrpc: \"2.0\", id: 0, result: res.result };\n    }\n    async _eth_sendTransaction(params) {\n        this._requireAuthorization();\n        const tx = this._prepareTransactionParams(params[0] || {});\n        try {\n            const relay = await this.initializeRelay();\n            const res = await relay.signAndSubmitEthereumTransaction(tx);\n            return { jsonrpc: \"2.0\", id: 0, result: res.result };\n        }\n        catch (err) {\n            if (typeof err.message === \"string\" &&\n                err.message.match(/(denied|rejected)/i)) {\n                throw eth_rpc_errors_1.ethErrors.provider.userRejectedRequest(\"User denied transaction signature\");\n            }\n            throw err;\n        }\n    }\n    async _eth_signTypedData_v1(params) {\n        this._requireAuthorization();\n        const typedData = util_1.ensureParsedJSONObject(params[0]);\n        const address = util_1.ensureAddressString(params[1]);\n        this._ensureKnownAddress(address);\n        const message = eth_eip712_util_1.default.hashForSignTypedDataLegacy({ data: typedData });\n        const typedDataJSON = JSON.stringify(typedData, null, 2);\n        return this._signEthereumMessage(message, address, false, typedDataJSON);\n    }\n    async _eth_signTypedData_v3(params) {\n        this._requireAuthorization();\n        const address = util_1.ensureAddressString(params[0]);\n        const typedData = util_1.ensureParsedJSONObject(params[1]);\n        this._ensureKnownAddress(address);\n        const message = eth_eip712_util_1.default.hashForSignTypedData_v3({ data: typedData });\n        const typedDataJSON = JSON.stringify(typedData, null, 2);\n        return this._signEthereumMessage(message, address, false, typedDataJSON);\n    }\n    async _eth_signTypedData_v4(params) {\n        this._requireAuthorization();\n        const address = util_1.ensureAddressString(params[0]);\n        const typedData = util_1.ensureParsedJSONObject(params[1]);\n        this._ensureKnownAddress(address);\n        const message = eth_eip712_util_1.default.hashForSignTypedData_v4({ data: typedData });\n        const typedDataJSON = JSON.stringify(typedData, null, 2);\n        return this._signEthereumMessage(message, address, false, typedDataJSON);\n    }\n    async _walletlink_arbitrary(params) {\n        const data = params[0];\n        if (typeof data !== \"string\") {\n            throw new Error(\"parameter must be a string\");\n        }\n        const result = await this.arbitraryRequest(data);\n        return { jsonrpc: \"2.0\", id: 0, result };\n    }\n    _eth_uninstallFilter(params) {\n        const filterId = util_1.ensureHexString(params[0]);\n        return this._filterPolyfill.uninstallFilter(filterId);\n    }\n    async _eth_newFilter(params) {\n        const param = params[0];\n        const filterId = await this._filterPolyfill.newFilter(param);\n        return { jsonrpc: \"2.0\", id: 0, result: filterId };\n    }\n    async _eth_newBlockFilter() {\n        const filterId = await this._filterPolyfill.newBlockFilter();\n        return { jsonrpc: \"2.0\", id: 0, result: filterId };\n    }\n    async _eth_newPendingTransactionFilter() {\n        const filterId = await this._filterPolyfill.newPendingTransactionFilter();\n        return { jsonrpc: \"2.0\", id: 0, result: filterId };\n    }\n    _eth_getFilterChanges(params) {\n        const filterId = util_1.ensureHexString(params[0]);\n        return this._filterPolyfill.getFilterChanges(filterId);\n    }\n    _eth_getFilterLogs(params) {\n        const filterId = util_1.ensureHexString(params[0]);\n        return this._filterPolyfill.getFilterLogs(filterId);\n    }\n    initializeRelay() {\n        if (this._relay) {\n            return Promise.resolve(this._relay);\n        }\n        return this._relayProvider().then(relay => {\n            relay.setChainIdCallback((chainId) => {\n                this.updateProviderInfo(this._jsonRpcUrl, parseInt(chainId, 10), true);\n            });\n            relay.setJsonRpcUrlCallback((jsonRpcUrl) => {\n                this.updateProviderInfo(jsonRpcUrl, this._chainId, true);\n            });\n            this._relay = relay;\n            return relay;\n        });\n    }\n}\nexports.WalletLinkProvider = WalletLinkProvider;\n"]},"metadata":{},"sourceType":"script"}